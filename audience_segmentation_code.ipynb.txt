{
  "cells": [
    {
      "cell_type": "code",
      "source": [
        "# Copyright 2022 Google LLC\n",
        "#\n",
        "# Licensed under the Apache License, Version 2.0 (the \"License\");\n",
        "# you may not use this file except in compliance with the License.\n",
        "# You may obtain a copy of the License at\n",
        "#\n",
        "#     https://www.apache.org/licenses/LICENSE-2.0\n",
        "#\n",
        "# Unless required by applicable law or agreed to in writing, software\n",
        "# distributed under the License is distributed on an \"AS IS\" BASIS,\n",
        "# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n",
        "# See the License for the specific language governing permissions and\n",
        "# limitations under the License."
      ],
      "metadata": {
        "id": "tpwX9ySYHqwm"
      },
      "id": "tpwX9ySYHqwm",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "<table align=\"left\">\n",
        "\n",
        "  <td>\n",
        "    <a href=\"https://colab.research.google.com/github/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/notebook_template.ipynb\">\n",
        "      <img src=\"https://cloud.google.com/ml-engine/images/colab-logo-32px.png\" alt=\"Colab logo\"> Run in Colab\n",
        "    </a>\n",
        "  </td>\n",
        "  <td>\n",
        "    <a href=\"https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/notebook_template.ipynb\">\n",
        "      <img src=\"https://cloud.google.com/ml-engine/images/github-logo-32px.png\" alt=\"GitHub logo\">\n",
        "      View on GitHub\n",
        "    </a>\n",
        "  </td>\n",
        "  <td>\n",
        "    <a href=\"https://console.cloud.google.com/vertex-ai/workbench/deploy-notebook?download_url=https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/notebook_template.ipynb\">\n",
        "      <img src=\"https://lh3.googleusercontent.com/UiNooY4LUgW_oTvpsNhPpQzsstV5W8F7rYgxgGBD85cWJoLmrOzhVs_ksK_vgx40SHs7jCqkTkCk=e14-rj-sc0xffffff-h130-w32\" alt=\"Vertex AI logo\">\n",
        "      Open in Vertex AI Workbench\n",
        "    </a>\n",
        "  </td>\n",
        "</table>"
      ],
      "metadata": {
        "id": "aBoKd8UlHuMk"
      },
      "id": "aBoKd8UlHuMk"
    },
    {
      "cell_type": "markdown",
      "id": "0462bd41-ac34-4250-9307-3843e25f2a87",
      "metadata": {
        "id": "0462bd41-ac34-4250-9307-3843e25f2a87"
      },
      "source": [
        "# E-Commerce Audience Segmentation using using Google Analytics (GA4) Data"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "f1bca8e3-ea6f-4a68-8358-659ff9fc6df0",
      "metadata": {
        "id": "f1bca8e3-ea6f-4a68-8358-659ff9fc6df0"
      },
      "source": [
        "Learn how to build a system to create audience segmentation of GA4 e-commerce data using BigQuery ML (BQML)."
      ]
    },
    {
      "cell_type": "markdown",
      "id": "16051aa1-62b0-44a5-83ae-dd038f849eee",
      "metadata": {
        "id": "16051aa1-62b0-44a5-83ae-dd038f849eee"
      },
      "source": [
        "With recent changes, BigQuery ML can directly access GA4 data, bringing capture app and web data in a single interface. This integration opens many opportunities for various machine learning use cases and potential customers. For example, the e-commerce industry can funnel their GA4 data to BQML and expand their analytics with ML capabilities. This pattern aims to help such companies leverage different ML algorithms and scale their analytics with BQ."
      ]
    },
    {
      "cell_type": "markdown",
      "id": "56691fb0-e600-45e9-8e27-b80b360d9e8e",
      "metadata": {
        "id": "56691fb0-e600-45e9-8e27-b80b360d9e8e"
      },
      "source": [
        "Customer segmentation, or grouping customers based on common characteristics, allows e-commerce businesses to provide relevant and timely customer promotions and offers. For example, customers buying behaviors are influenced by their demographics, surfing habits, interests, and even the gadgets they use. The buying behavior will impact what they buy, why they buy, and how much money they spend on each purchase.\n",
        "\n",
        "When combined with behavioral data, customer segmentation allows online retailers to provide tailored experiences similar to those found in a customer's favorite neighborhood store."
      ]
    },
    {
      "cell_type": "markdown",
      "id": "f6042ad4-3a29-4e58-910c-5fe6fd7d5df1",
      "metadata": {
        "id": "f6042ad4-3a29-4e58-910c-5fe6fd7d5df1"
      },
      "source": [
        "Customers can use K-means clustering, included in BQML, on their e-commerce GA4 Data to quickly create customer segments. Clustering will allow users of similar behaviors in GA4 to be segmented, personalizing client outreach by adapting ads and other messages to their tastes and habits, as evidenced by the cluster each customer belongs."
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "One thing to note is that GA4 has an [inbuild predictive audience feature](https://support.google.com/analytics/answer/9805833) that helps segment customers based on churn, purchases, and spending. However, the solution discussed in the pattern is different from that in the sense that it tries to bring more dynamic features like user demographic and interests (page view based). The inbuilt feature is more static, while the pattern is more dynamic since it uses machine learning."
      ],
      "metadata": {
        "id": "ZNooLB1Wq9Vf"
      },
      "id": "ZNooLB1Wq9Vf"
    },
    {
      "cell_type": "markdown",
      "id": "3a50caf5-6a68-4c81-9b4a-613b66a600d6",
      "metadata": {
        "id": "3a50caf5-6a68-4c81-9b4a-613b66a600d6"
      },
      "source": [
        "## Objective\n",
        "\n",
        "The design pattern involves the following steps:\n",
        "\n",
        "- Loading the e-commerce data\n",
        "- Exploratory analysis of the data\n",
        "- Feature engineering and pre-processing of the data for model\n",
        "- Create, train, and deploy the model in BigQuery\n",
        "- Evaluate the model to understand various clusters\n",
        "- Batch prediction using the trained model"
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Audience\n",
        "The pattern is intended for marketing analytics teams for an enterprise, or, teams explicitly responsible for analyzing Google Analytics data. It assumes that you have basic knowledge of the following:\n",
        "\n",
        "- Machine Learning concepts\n",
        "- Standard SQL & Python"
      ],
      "metadata": {
        "id": "lwYLPV4xUuAC"
      },
      "id": "lwYLPV4xUuAC"
    },
    {
      "cell_type": "markdown",
      "id": "9150b5b9-b8a0-443e-ac34-77033acec59a",
      "metadata": {
        "id": "9150b5b9-b8a0-443e-ac34-77033acec59a"
      },
      "source": [
        "## Costs\n",
        "This tutorial uses the following billable components of Google Cloud:\n",
        "\n",
        "- BigQuery\n",
        "- BigQuery ML\n",
        "- Cloud Storage\n",
        "\n",
        "\n",
        "To generate a cost estimate based on your projected usage, use the pricing calculator.\n",
        "\n",
        "Learn about\n",
        "- [BigQuery\n",
        "pricing](https://cloud.google.com/bigquery/pricing),\n",
        "- [BigQuery ML pricing](https://cloud.google.com/bigquery-ml/pricing),\n",
        "- [Cloud Storage\n",
        "pricing](https://cloud.google.com/storage/pricing),\n",
        "\n",
        "and use the [Pricing\n",
        "Calculator](https://cloud.google.com/products/calculator/)\n",
        "to generate a cost estimate based on your projected usage."
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "## The Dataset\n",
        "The solution uses the public [GA4 Google Merchandise Store](https://console.cloud.google.com/bigquery?p=bigquery-public-data&d=ga4_obfuscated_sample_ecommerce) dataset.\n",
        "\n",
        "Google Merchandise Store is an online store that sells Google-branded merchandise. The site uses Google Analytics 4's standard web ecommerce implementation along with enhanced measurement. The ga4_obfuscated_sample_ecommerce dataset available through the BigQuery Public Datasets program and contains a sample of obfuscated BigQuery event export data for three months from 2020-11-01 to 2021-01-31.\n",
        "\n",
        "\n"
      ],
      "metadata": {
        "id": "nSxUki7YZjJt"
      },
      "id": "nSxUki7YZjJt"
    },
    {
      "cell_type": "markdown",
      "source": [
        "This dataset contains obfuscated data that emulates what a real world dataset would look like from an actual Google Analytics 4 implementation. Certain fields will contain placeholder values including <Other>, NULL, and \" \" . Due to obfuscation, internal consistency of the dataset might be somewhat limited.\n",
        "\n"
      ],
      "metadata": {
        "id": "jx5ZSKnvw5fO"
      },
      "id": "jx5ZSKnvw5fO"
    },
    {
      "cell_type": "markdown",
      "source": [
        "To play with the data on your BQ Console, follow this [quick code](https://developers.google.com/analytics/bigquery/web-ecommerce-demo-dataset#using_the_dataset)\n",
        "\n",
        "You can check the schema details of the dataset [here](https://support.google.com/analytics/answer/7029846#zippy=)\n",
        "\n",
        "There are total 23 columns in the datasets with mixed datatypes, and approximately 4 million rows (each day event is seperate table in the data and total 92 events(tables) are present)."
      ],
      "metadata": {
        "id": "Du_xhjb2w8UF"
      },
      "id": "Du_xhjb2w8UF"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Exporting Google Analytics data to BigQuery\n",
        "If instead of the sample data, you want to use your own data from a GA4 property, you can follow the instructions in [(GA4) Set up BigQuery ](https://support.google.com/analytics/answer/9823238#zippy=%2Cin-this-article) Export to export your data."
      ],
      "metadata": {
        "id": "lxvH0lhKdsP4"
      },
      "id": "lxvH0lhKdsP4"
    },
    {
      "cell_type": "markdown",
      "source": [
        "### Set up your local development environment\n",
        "\n",
        "**If you are using Colab or Google Cloud Notebooks**, your environment already meets\n",
        "all the requirements to run this notebook. You can skip this step."
      ],
      "metadata": {
        "id": "3Ro0D7_NIJ9t"
      },
      "id": "3Ro0D7_NIJ9t"
    },
    {
      "cell_type": "markdown",
      "source": [
        "**Otherwise**, make sure your environment meets this notebook's requirements.\n",
        "You need the following:\n",
        "\n",
        "* The Google Cloud SDK\n",
        "* Python 3\n",
        "* Jupyter notebook running in a virtual environment with Python 3\n",
        "\n",
        "The Google Cloud guide to [Setting up a Python development\n",
        "environment](https://cloud.google.com/python/setup) and the [Jupyter\n",
        "installation guide](https://jupyter.org/install) provide detailed instructions\n",
        "for meeting these requirements. The following steps provide a condensed set of\n",
        "instructions:\n",
        "\n",
        "1. [Install and initialize the Cloud SDK.](https://cloud.google.com/sdk/docs/)\n",
        "\n",
        "1. [Install Python 3.](https://cloud.google.com/python/setup#installing_python)\n",
        "\n",
        "1. [Install\n",
        "   virtualenv](https://cloud.google.com/python/setup#installing_and_using_virtualenv)\n",
        "   and create a virtual environment that uses Python 3. Activate the virtual environment.\n",
        "\n",
        "1. To install Jupyter, run `pip3 install jupyter` on the\n",
        "command-line in a terminal shell.\n",
        "\n",
        "1. To launch Jupyter, run `jupyter notebook` on the command-line in a terminal shell.\n",
        "\n",
        "1. Open this notebook in the Jupyter Notebook Dashboard."
      ],
      "metadata": {
        "id": "naVsQIkoIKqi"
      },
      "id": "naVsQIkoIKqi"
    },
    {
      "cell_type": "markdown",
      "source": [
        "### Install additional packages\n",
        "\n",
        "Install additional package dependencies not installed in your notebook environment, such as {plotly.express, pandas, google.cloud}. Use the latest major GA version of each package."
      ],
      "metadata": {
        "id": "-kMgGax-IS1F"
      },
      "id": "-kMgGax-IS1F"
    },
    {
      "cell_type": "code",
      "source": [
        "import os\n",
        "\n",
        "# The Google Cloud Notebook product has specific requirements\n",
        "IS_GOOGLE_CLOUD_NOTEBOOK = os.path.exists(\"/opt/deeplearning/metadata/env_version\")\n",
        "\n",
        "# Google Cloud Notebook requires dependencies to be installed with '--user'\n",
        "USER_FLAG = \"\"\n",
        "if IS_GOOGLE_CLOUD_NOTEBOOK:\n",
        "    USER_FLAG = \"--user\""
      ],
      "metadata": {
        "id": "BNG1a0WFIWsR"
      },
      "id": "BNG1a0WFIWsR",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "### Restart the kernel\n",
        "\n",
        "After you install the additional packages, you need to restart the notebook kernel so it can find the packages."
      ],
      "metadata": {
        "id": "cmiF7wD2IXbk"
      },
      "id": "cmiF7wD2IXbk"
    },
    {
      "cell_type": "code",
      "source": [
        "# Automatically restart kernel after installs\n",
        "import os\n",
        "\n",
        "if not os.getenv(\"IS_TESTING\"):\n",
        "    # Automatically restart kernel after installs\n",
        "    import IPython\n",
        "\n",
        "    app = IPython.Application.instance()\n",
        "    app.kernel.do_shutdown(True)"
      ],
      "metadata": {
        "id": "Ng8iy7LaIa9q"
      },
      "id": "Ng8iy7LaIa9q",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Before you begin"
      ],
      "metadata": {
        "id": "bKoNzVCxIf7O"
      },
      "id": "bKoNzVCxIf7O"
    },
    {
      "cell_type": "markdown",
      "source": [
        "### Set up your Google Cloud project\n",
        "\n",
        "**The following steps are required, regardless of your notebook environment.**\n",
        "\n",
        "1. [Select or create a Google Cloud project](https://console.cloud.google.com/cloud-resource-manager). When you first create an account, you get a $300 free credit towards your compute/storage costs.\n",
        "\n",
        "2. [Make sure that billing is enabled for your project](https://cloud.google.com/billing/docs/how-to/modify-project).\n",
        "\n",
        "\n",
        "3. If you are running this notebook locally, you will need to install the [Cloud SDK](https://cloud.google.com/sdk).\n",
        "\n",
        "4. Enter your project ID in the cell below. Then run the cell to make sure the\n",
        "Cloud SDK uses the right project for all the commands in this notebook.\n",
        "\n",
        "**Note**: Jupyter runs lines prefixed with `!` as shell commands, and it interpolates Python variables prefixed with `$` into these commands."
      ],
      "metadata": {
        "id": "EFwFJmXZIgqV"
      },
      "id": "EFwFJmXZIgqV"
    },
    {
      "cell_type": "markdown",
      "source": [
        "#### Set your project ID\n",
        "\n",
        "**If you don't know your project ID**, you may be able to get your project ID using `gcloud`."
      ],
      "metadata": {
        "id": "WbtKuolkIo2k"
      },
      "id": "WbtKuolkIo2k"
    },
    {
      "cell_type": "code",
      "source": [
        "PROJECT_ID = \"\"\n",
        "\n",
        "# Get your Google Cloud project ID from gcloud\n",
        "if not os.getenv(\"IS_TESTING\"):\n",
        "    shell_output = !gcloud config list --format 'value(core.project)' 2>/dev/null\n",
        "    PROJECT_ID = shell_output[0]\n",
        "    print(\"Project ID: \", PROJECT_ID)"
      ],
      "metadata": {
        "id": "SsjOE5jkIsuU",
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "outputId": "90351561-e4d1-4271-c0ce-000bdf31f83e"
      },
      "id": "SsjOE5jkIsuU",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Project ID:  \n"
          ]
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "Otherwise, set your project ID here."
      ],
      "metadata": {
        "id": "S8aHk0AQIxlM"
      },
      "id": "S8aHk0AQIxlM"
    },
    {
      "cell_type": "code",
      "source": [
        "if PROJECT_ID == \"\" or PROJECT_ID is None:\n",
        "    PROJECT_ID = \"ga4-bq-pattern\"  # @param {type:\"string\"}"
      ],
      "metadata": {
        "id": "kbAokgs1Iz_o"
      },
      "id": "kbAokgs1Iz_o",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "### Authenticate your Google Cloud account\n",
        "\n",
        "**If you are using Google Cloud Notebooks**, your environment is already\n",
        "authenticated. Skip this step."
      ],
      "metadata": {
        "id": "vafnp9fDI-Jy"
      },
      "id": "vafnp9fDI-Jy"
    },
    {
      "cell_type": "code",
      "source": [
        "import os\n",
        "import sys\n",
        "\n",
        "# If you are running this notebook in Colab, run this cell and follow the\n",
        "# instructions to authenticate your GCP account. This provides access to your\n",
        "# Cloud Storage bucket and lets you submit training jobs and prediction\n",
        "# requests.\n",
        "\n",
        "# The Google Cloud Notebook product has specific requirements\n",
        "IS_GOOGLE_CLOUD_NOTEBOOK = os.path.exists(\"/opt/deeplearning/metadata/env_version\")\n",
        "\n",
        "# If on Google Cloud Notebooks, then don't execute this code\n",
        "if not IS_GOOGLE_CLOUD_NOTEBOOK:\n",
        "    if \"google.colab\" in sys.modules:\n",
        "        from google.colab import auth as google_auth\n",
        "\n",
        "        google_auth.authenticate_user()\n",
        "\n",
        "    # If you are running this notebook locally, replace the string below with the\n",
        "    # path to your service account key and run this cell to authenticate your GCP\n",
        "    # account.\n",
        "    elif not os.getenv(\"IS_TESTING\"):\n",
        "        %env GOOGLE_APPLICATION_CREDENTIALS ''"
      ],
      "metadata": {
        "id": "KmPLvdx-JFti"
      },
      "id": "KmPLvdx-JFti",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "5cf783db-023f-41d1-8753-b194ccefc759",
      "metadata": {
        "id": "5cf783db-023f-41d1-8753-b194ccefc759"
      },
      "outputs": [],
      "source": [
        "# Importing some important libraries that will be used during the notebook\n",
        "import pandas as pd\n",
        "import plotly.express as px\n",
        "from google.cloud import bigquery"
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "#Client manages connections to the BigQuery API and helps\n",
        "#bundle configuration (project, credentials) needed for API requests.\n",
        "client = bigquery.Client(PROJECT_ID)\n",
        "\n",
        "# to make sure all columns are displayed while working with dataframe\n",
        "pd.set_option('display.max_columns', None)"
      ],
      "metadata": {
        "id": "u4AoPtwKSNhm"
      },
      "id": "u4AoPtwKSNhm",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Assumptions"
      ],
      "metadata": {
        "id": "2_BpasBjb3eG"
      },
      "id": "2_BpasBjb3eG"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Exploratory Data Analysis (EDA)"
      ],
      "metadata": {
        "id": "oMutkEaqhJsJ"
      },
      "id": "oMutkEaqhJsJ"
    },
    {
      "cell_type": "markdown",
      "source": [
        "You can start by defining some essential variables that can change according to your data. It is always better to consider the most recent records from your data as features. For this purpose, you can set the START_DATE and END_DATE based on your data recency.\n",
        "\n",
        "In this case, the date range is set for 3 months."
      ],
      "metadata": {
        "id": "Jj4q_owsvDI8"
      },
      "id": "Jj4q_owsvDI8"
    },
    {
      "cell_type": "code",
      "source": [
        "# Dataset (GA4 Google Merchandise Store) specific Variable\n",
        "# Change it to your dataset spefic values, if you want to use the code for your data.\n",
        "# We assume table names will be \"events_*\"\n",
        "PROJECT_ID_DATA = \"bigquery-public-data\"\n",
        "DATASET_ID_DATA = \"ga4_obfuscated_sample_ecommerce\" #ga4-bq-pattern.1crdata.fake_ga4 #ga4_obfuscated_sample_ecommerce\n",
        "START_DATE = \"20201101\"\n",
        "END_DATE = \"20210131\" # taking 3 months recent data.\n",
        "#In queries, these variables are editable so that you can put your project, dataset, and date,\n",
        "#making it easier for you to make the least amount of changes. Of course, you don't need to change\n",
        "#it for public data. But, for making the queries editable, it made sense to define them here.\n",
        "#You can run the whole notebook (mostly) with your data by changing values here."
      ],
      "metadata": {
        "id": "YI1pDBZMu5hm"
      },
      "id": "YI1pDBZMu5hm",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "### Why EDA?\n",
        "\n",
        "Before starting the audience segmentation, it's essential to identify the various attributes commonly referred to as features (in ML),  based on which the intended audience should be segmented. For example, you can segment your customers based on different languages, locations, pages, and interests on your website, mobile company, shipping methods, etc.\n",
        "\n",
        "There could be a lot of such features in your data that can be helpful for the model. The quickest way to achieve this is to ask your business stakeholder. They can help you identify specific attributes or columns that might be a good feature for the model.\n",
        "\n",
        "\n",
        "The alternative way is to do exploratory data analysis (EDA) processes, where you analyze and summarize the data through visualizations and identify the most relevant attributes. Each step in EDA will guide you in creating good features for your models.\n",
        "\n",
        "The most common pitfall in modeling is to choose features that are not well represented and distributed - statistically, since they tend to result in sub-optimal model outputs.\n",
        "\n",
        "So, with EDA, the goal here is to:\n",
        "\n",
        "- Find the value distribution, availability, and data types of columns.\n",
        "- Aggregate summary statistics for important columns.\n",
        "- Identify critical columns to be used as features."
      ],
      "metadata": {
        "id": "rzXCHmAdLKK-"
      },
      "id": "rzXCHmAdLKK-"
    },
    {
      "cell_type": "markdown",
      "id": "b9613d67-35cd-40c3-b7e4-f08926c7594f",
      "metadata": {
        "id": "b9613d67-35cd-40c3-b7e4-f08926c7594f"
      },
      "source": [
        "You can start the data exploration by returning the first five rows of data.\n",
        "The data has multiple event tables for each day. So, all the tables (events) could be queried by using events* as the wildcard.\n",
        "\n",
        "[GA4 Data Export Schema](https://support.google.com/analytics/answer/7029846#zippy=)\n",
        "\n",
        "Note: BigQuery export, by default, are [date sharded tables](https://cloud.google.com/bigquery/docs/partitioned-tables#dt_partition_shard)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "35270b17-147e-495f-8839-ffe363db0aa7",
      "metadata": {
        "id": "35270b17-147e-495f-8839-ffe363db0aa7",
        "outputId": "3b2925d5-9203-4c33-e62b-7801544bcf96",
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 531
        }
      },
      "outputs": [
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "  event_date   event_timestamp       event_name  \\\n",
              "0   20210102  1609568188059459        page_view   \n",
              "1   20210102  1609568195189041  user_engagement   \n",
              "2   20210102  1609568182969088      first_visit   \n",
              "3   20210102  1609568182969088        page_view   \n",
              "4   20210102  1609568182969088    session_start   \n",
              "\n",
              "                                        event_params event_previous_timestamp  \\\n",
              "0  [{'key': 'gclsrc', 'value': {'string_value': N...                     None   \n",
              "1  [{'key': 'gclid', 'value': {'string_value': No...                     None   \n",
              "2  [{'key': 'page_title', 'value': {'string_value...                     None   \n",
              "3  [{'key': 'all_data', 'value': {'string_value':...                     None   \n",
              "4  [{'key': 'ga_session_number', 'value': {'strin...                     None   \n",
              "\n",
              "  event_value_in_usd  event_bundle_sequence_id event_server_timestamp_offset  \\\n",
              "0               None               -1513542123                          None   \n",
              "1               None               -6183258510                          None   \n",
              "2               None               -3741031938                          None   \n",
              "3               None               -3741031938                          None   \n",
              "4               None               -3741031938                          None   \n",
              "\n",
              "  user_id      user_pseudo_id  \\\n",
              "0    None  1005484.1092567297   \n",
              "1    None  1005484.1092567297   \n",
              "2    None  1005484.1092567297   \n",
              "3    None  1005484.1092567297   \n",
              "4    None  1005484.1092567297   \n",
              "\n",
              "                                        privacy_info user_properties  \\\n",
              "0  {'analytics_storage': None, 'ads_storage': Non...              []   \n",
              "1  {'analytics_storage': None, 'ads_storage': Non...              []   \n",
              "2  {'analytics_storage': None, 'ads_storage': Non...              []   \n",
              "3  {'analytics_storage': None, 'ads_storage': Non...              []   \n",
              "4  {'analytics_storage': None, 'ads_storage': Non...              []   \n",
              "\n",
              "   user_first_touch_timestamp                             user_ltv  \\\n",
              "0            1609568182969088  {'revenue': 0.0, 'currency': 'USD'}   \n",
              "1            1609568182969088  {'revenue': 0.0, 'currency': 'USD'}   \n",
              "2            1609568182969088  {'revenue': 0.0, 'currency': 'USD'}   \n",
              "3            1609568182969088  {'revenue': 0.0, 'currency': 'USD'}   \n",
              "4            1609568182969088  {'revenue': 0.0, 'currency': 'USD'}   \n",
              "\n",
              "                                              device  \\\n",
              "0  {'category': 'desktop', 'mobile_brand_name': '...   \n",
              "1  {'category': 'desktop', 'mobile_brand_name': '...   \n",
              "2  {'category': 'desktop', 'mobile_brand_name': '...   \n",
              "3  {'category': 'desktop', 'mobile_brand_name': '...   \n",
              "4  {'category': 'desktop', 'mobile_brand_name': '...   \n",
              "\n",
              "                                                 geo app_info  \\\n",
              "0  {'continent': 'Americas', 'sub_continent': 'No...     None   \n",
              "1  {'continent': 'Americas', 'sub_continent': 'No...     None   \n",
              "2  {'continent': 'Americas', 'sub_continent': 'No...     None   \n",
              "3  {'continent': 'Americas', 'sub_continent': 'No...     None   \n",
              "4  {'continent': 'Americas', 'sub_continent': 'No...     None   \n",
              "\n",
              "                                      traffic_source   stream_id platform  \\\n",
              "0  {'medium': 'organic', 'name': '(organic)', 'so...  2100450278      WEB   \n",
              "1  {'medium': 'organic', 'name': '(organic)', 'so...  2100450278      WEB   \n",
              "2  {'medium': 'organic', 'name': '(organic)', 'so...  2100450278      WEB   \n",
              "3  {'medium': 'organic', 'name': '(organic)', 'so...  2100450278      WEB   \n",
              "4  {'medium': 'organic', 'name': '(organic)', 'so...  2100450278      WEB   \n",
              "\n",
              "  event_dimensions                                          ecommerce items  \n",
              "0             None  {'total_item_quantity': None, 'purchase_revenu...    []  \n",
              "1             None  {'total_item_quantity': None, 'purchase_revenu...    []  \n",
              "2             None  {'total_item_quantity': None, 'purchase_revenu...    []  \n",
              "3             None  {'total_item_quantity': None, 'purchase_revenu...    []  \n",
              "4             None  {'total_item_quantity': None, 'purchase_revenu...    []  "
            ],
            "text/html": [
              "\n",
              "  <div id=\"df-48398c1b-d7ac-4f72-8570-c9c84982c38e\">\n",
              "    <div class=\"colab-df-container\">\n",
              "      <div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>event_date</th>\n",
              "      <th>event_timestamp</th>\n",
              "      <th>event_name</th>\n",
              "      <th>event_params</th>\n",
              "      <th>event_previous_timestamp</th>\n",
              "      <th>event_value_in_usd</th>\n",
              "      <th>event_bundle_sequence_id</th>\n",
              "      <th>event_server_timestamp_offset</th>\n",
              "      <th>user_id</th>\n",
              "      <th>user_pseudo_id</th>\n",
              "      <th>privacy_info</th>\n",
              "      <th>user_properties</th>\n",
              "      <th>user_first_touch_timestamp</th>\n",
              "      <th>user_ltv</th>\n",
              "      <th>device</th>\n",
              "      <th>geo</th>\n",
              "      <th>app_info</th>\n",
              "      <th>traffic_source</th>\n",
              "      <th>stream_id</th>\n",
              "      <th>platform</th>\n",
              "      <th>event_dimensions</th>\n",
              "      <th>ecommerce</th>\n",
              "      <th>items</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>20210102</td>\n",
              "      <td>1609568188059459</td>\n",
              "      <td>page_view</td>\n",
              "      <td>[{'key': 'gclsrc', 'value': {'string_value': N...</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>-1513542123</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>1005484.1092567297</td>\n",
              "      <td>{'analytics_storage': None, 'ads_storage': Non...</td>\n",
              "      <td>[]</td>\n",
              "      <td>1609568182969088</td>\n",
              "      <td>{'revenue': 0.0, 'currency': 'USD'}</td>\n",
              "      <td>{'category': 'desktop', 'mobile_brand_name': '...</td>\n",
              "      <td>{'continent': 'Americas', 'sub_continent': 'No...</td>\n",
              "      <td>None</td>\n",
              "      <td>{'medium': 'organic', 'name': '(organic)', 'so...</td>\n",
              "      <td>2100450278</td>\n",
              "      <td>WEB</td>\n",
              "      <td>None</td>\n",
              "      <td>{'total_item_quantity': None, 'purchase_revenu...</td>\n",
              "      <td>[]</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>1</th>\n",
              "      <td>20210102</td>\n",
              "      <td>1609568195189041</td>\n",
              "      <td>user_engagement</td>\n",
              "      <td>[{'key': 'gclid', 'value': {'string_value': No...</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>-6183258510</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>1005484.1092567297</td>\n",
              "      <td>{'analytics_storage': None, 'ads_storage': Non...</td>\n",
              "      <td>[]</td>\n",
              "      <td>1609568182969088</td>\n",
              "      <td>{'revenue': 0.0, 'currency': 'USD'}</td>\n",
              "      <td>{'category': 'desktop', 'mobile_brand_name': '...</td>\n",
              "      <td>{'continent': 'Americas', 'sub_continent': 'No...</td>\n",
              "      <td>None</td>\n",
              "      <td>{'medium': 'organic', 'name': '(organic)', 'so...</td>\n",
              "      <td>2100450278</td>\n",
              "      <td>WEB</td>\n",
              "      <td>None</td>\n",
              "      <td>{'total_item_quantity': None, 'purchase_revenu...</td>\n",
              "      <td>[]</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>2</th>\n",
              "      <td>20210102</td>\n",
              "      <td>1609568182969088</td>\n",
              "      <td>first_visit</td>\n",
              "      <td>[{'key': 'page_title', 'value': {'string_value...</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>-3741031938</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>1005484.1092567297</td>\n",
              "      <td>{'analytics_storage': None, 'ads_storage': Non...</td>\n",
              "      <td>[]</td>\n",
              "      <td>1609568182969088</td>\n",
              "      <td>{'revenue': 0.0, 'currency': 'USD'}</td>\n",
              "      <td>{'category': 'desktop', 'mobile_brand_name': '...</td>\n",
              "      <td>{'continent': 'Americas', 'sub_continent': 'No...</td>\n",
              "      <td>None</td>\n",
              "      <td>{'medium': 'organic', 'name': '(organic)', 'so...</td>\n",
              "      <td>2100450278</td>\n",
              "      <td>WEB</td>\n",
              "      <td>None</td>\n",
              "      <td>{'total_item_quantity': None, 'purchase_revenu...</td>\n",
              "      <td>[]</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>3</th>\n",
              "      <td>20210102</td>\n",
              "      <td>1609568182969088</td>\n",
              "      <td>page_view</td>\n",
              "      <td>[{'key': 'all_data', 'value': {'string_value':...</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>-3741031938</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>1005484.1092567297</td>\n",
              "      <td>{'analytics_storage': None, 'ads_storage': Non...</td>\n",
              "      <td>[]</td>\n",
              "      <td>1609568182969088</td>\n",
              "      <td>{'revenue': 0.0, 'currency': 'USD'}</td>\n",
              "      <td>{'category': 'desktop', 'mobile_brand_name': '...</td>\n",
              "      <td>{'continent': 'Americas', 'sub_continent': 'No...</td>\n",
              "      <td>None</td>\n",
              "      <td>{'medium': 'organic', 'name': '(organic)', 'so...</td>\n",
              "      <td>2100450278</td>\n",
              "      <td>WEB</td>\n",
              "      <td>None</td>\n",
              "      <td>{'total_item_quantity': None, 'purchase_revenu...</td>\n",
              "      <td>[]</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>4</th>\n",
              "      <td>20210102</td>\n",
              "      <td>1609568182969088</td>\n",
              "      <td>session_start</td>\n",
              "      <td>[{'key': 'ga_session_number', 'value': {'strin...</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>-3741031938</td>\n",
              "      <td>None</td>\n",
              "      <td>None</td>\n",
              "      <td>1005484.1092567297</td>\n",
              "      <td>{'analytics_storage': None, 'ads_storage': Non...</td>\n",
              "      <td>[]</td>\n",
              "      <td>1609568182969088</td>\n",
              "      <td>{'revenue': 0.0, 'currency': 'USD'}</td>\n",
              "      <td>{'category': 'desktop', 'mobile_brand_name': '...</td>\n",
              "      <td>{'continent': 'Americas', 'sub_continent': 'No...</td>\n",
              "      <td>None</td>\n",
              "      <td>{'medium': 'organic', 'name': '(organic)', 'so...</td>\n",
              "      <td>2100450278</td>\n",
              "      <td>WEB</td>\n",
              "      <td>None</td>\n",
              "      <td>{'total_item_quantity': None, 'purchase_revenu...</td>\n",
              "      <td>[]</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>\n",
              "      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-48398c1b-d7ac-4f72-8570-c9c84982c38e')\"\n",
              "              title=\"Convert this dataframe to an interactive table.\"\n",
              "              style=\"display:none;\">\n",
              "        \n",
              "  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n",
              "       width=\"24px\">\n",
              "    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n",
              "    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n",
              "  </svg>\n",
              "      </button>\n",
              "      \n",
              "  <style>\n",
              "    .colab-df-container {\n",
              "      display:flex;\n",
              "      flex-wrap:wrap;\n",
              "      gap: 12px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert {\n",
              "      background-color: #E8F0FE;\n",
              "      border: none;\n",
              "      border-radius: 50%;\n",
              "      cursor: pointer;\n",
              "      display: none;\n",
              "      fill: #1967D2;\n",
              "      height: 32px;\n",
              "      padding: 0 0 0 0;\n",
              "      width: 32px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert:hover {\n",
              "      background-color: #E2EBFA;\n",
              "      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n",
              "      fill: #174EA6;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert {\n",
              "      background-color: #3B4455;\n",
              "      fill: #D2E3FC;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert:hover {\n",
              "      background-color: #434B5C;\n",
              "      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n",
              "      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n",
              "      fill: #FFFFFF;\n",
              "    }\n",
              "  </style>\n",
              "\n",
              "      <script>\n",
              "        const buttonEl =\n",
              "          document.querySelector('#df-48398c1b-d7ac-4f72-8570-c9c84982c38e button.colab-df-convert');\n",
              "        buttonEl.style.display =\n",
              "          google.colab.kernel.accessAllowed ? 'block' : 'none';\n",
              "\n",
              "        async function convertToInteractive(key) {\n",
              "          const element = document.querySelector('#df-48398c1b-d7ac-4f72-8570-c9c84982c38e');\n",
              "          const dataTable =\n",
              "            await google.colab.kernel.invokeFunction('convertToInteractive',\n",
              "                                                     [key], {});\n",
              "          if (!dataTable) return;\n",
              "\n",
              "          const docLinkHtml = 'Like what you see? Visit the ' +\n",
              "            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n",
              "            + ' to learn more about interactive tables.';\n",
              "          element.innerHTML = '';\n",
              "          dataTable['output_type'] = 'display_data';\n",
              "          await google.colab.output.renderOutput(dataTable, element);\n",
              "          const docLink = document.createElement('div');\n",
              "          docLink.innerHTML = docLinkHtml;\n",
              "          element.appendChild(docLink);\n",
              "        }\n",
              "      </script>\n",
              "    </div>\n",
              "  </div>\n",
              "  "
            ]
          },
          "metadata": {},
          "execution_count": 16
        }
      ],
      "source": [
        "query = f\"\"\"\n",
        "SELECT\n",
        "  *\n",
        "FROM\n",
        "  `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events*`\n",
        "LIMIT\n",
        "  5\n",
        "\"\"\"\n",
        "query_job = client.query(query)\n",
        "top5_data = query_job.to_dataframe()\n",
        "top5_data.head()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "e665b736-7c46-4131-a1fa-d050d40e30f4",
      "metadata": {
        "id": "e665b736-7c46-4131-a1fa-d050d40e30f4"
      },
      "source": [
        "The first five rows of data can help you understand the tables' composite structure of data types. For example, you can see numerical, categorical, Arrays, and Struct as data types. Using this information, later, you will be able to write specific `UNNEST` queries for [Arrays](https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays#query_structs_in_an_array) & [Struct](https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays#querying_array-type_fields_in_a_struct)."
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "By looking at some columns, you can also identify a few essential features like event_date, event_name, user_ltv, device, geo, traffic_source, platform, and items. However, as discussed earlier, you still are not aware of their value distribution, availability, and data types."
      ],
      "metadata": {
        "id": "MXy4Sy-raeEr"
      },
      "id": "MXy4Sy-raeEr"
    },
    {
      "cell_type": "markdown",
      "source": [
        "You can check the data types of each column using [INFORMATION_SCHEMA](https://cloud.google.com/bigquery/docs/information-schema-tables) table. It can give you detailed metadata of your columns."
      ],
      "metadata": {
        "id": "qRGBRNZRYg7A"
      },
      "id": "qRGBRNZRYg7A"
    },
    {
      "cell_type": "code",
      "source": [
        "query = f\"\"\"\n",
        "SELECT\n",
        "  DISTINCT(column_name),\n",
        "  data_type\n",
        "FROM\n",
        "  `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.INFORMATION_SCHEMA.COLUMNS`\n",
        "\"\"\"\n",
        "\n",
        "query_job = client.query(query)\n",
        "predict_data = query_job.to_dataframe()\n",
        "predict_data"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 771
        },
        "id": "rgE--AsdTJnd",
        "outputId": "faceb837-3242-42ea-f503-99dcf315f23a"
      },
      "id": "rgE--AsdTJnd",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "                      column_name  \\\n",
              "0                      event_date   \n",
              "1                 event_timestamp   \n",
              "2                      event_name   \n",
              "3                    event_params   \n",
              "4        event_previous_timestamp   \n",
              "5              event_value_in_usd   \n",
              "6        event_bundle_sequence_id   \n",
              "7   event_server_timestamp_offset   \n",
              "8                         user_id   \n",
              "9                  user_pseudo_id   \n",
              "10                   privacy_info   \n",
              "11                user_properties   \n",
              "12     user_first_touch_timestamp   \n",
              "13                       user_ltv   \n",
              "14                         device   \n",
              "15                            geo   \n",
              "16                       app_info   \n",
              "17                 traffic_source   \n",
              "18                      stream_id   \n",
              "19                       platform   \n",
              "20               event_dimensions   \n",
              "21                      ecommerce   \n",
              "22                          items   \n",
              "\n",
              "                                            data_type  \n",
              "0                                              STRING  \n",
              "1                                               INT64  \n",
              "2                                              STRING  \n",
              "3   ARRAY<STRUCT<key STRING, value STRUCT<string_v...  \n",
              "4                                               INT64  \n",
              "5                                             FLOAT64  \n",
              "6                                               INT64  \n",
              "7                                               INT64  \n",
              "8                                              STRING  \n",
              "9                                              STRING  \n",
              "10  STRUCT<analytics_storage INT64, ads_storage IN...  \n",
              "11  ARRAY<STRUCT<key INT64, value STRUCT<string_va...  \n",
              "12                                              INT64  \n",
              "13           STRUCT<revenue FLOAT64, currency STRING>  \n",
              "14  STRUCT<category STRING, mobile_brand_name STRI...  \n",
              "15  STRUCT<continent STRING, sub_continent STRING,...  \n",
              "16  STRUCT<id STRING, version STRING, install_stor...  \n",
              "17  STRUCT<medium STRING, name STRING, source STRING>  \n",
              "18                                              INT64  \n",
              "19                                             STRING  \n",
              "20                            STRUCT<hostname STRING>  \n",
              "21  STRUCT<total_item_quantity INT64, purchase_rev...  \n",
              "22  ARRAY<STRUCT<item_id STRING, item_name STRING,...  "
            ],
            "text/html": [
              "\n",
              "  <div id=\"df-10be005d-420f-4e03-a406-40060d4ac8a0\">\n",
              "    <div class=\"colab-df-container\">\n",
              "      <div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>column_name</th>\n",
              "      <th>data_type</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>event_date</td>\n",
              "      <td>STRING</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>1</th>\n",
              "      <td>event_timestamp</td>\n",
              "      <td>INT64</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>2</th>\n",
              "      <td>event_name</td>\n",
              "      <td>STRING</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>3</th>\n",
              "      <td>event_params</td>\n",
              "      <td>ARRAY&lt;STRUCT&lt;key STRING, value STRUCT&lt;string_v...</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>4</th>\n",
              "      <td>event_previous_timestamp</td>\n",
              "      <td>INT64</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>5</th>\n",
              "      <td>event_value_in_usd</td>\n",
              "      <td>FLOAT64</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>6</th>\n",
              "      <td>event_bundle_sequence_id</td>\n",
              "      <td>INT64</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>7</th>\n",
              "      <td>event_server_timestamp_offset</td>\n",
              "      <td>INT64</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>8</th>\n",
              "      <td>user_id</td>\n",
              "      <td>STRING</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>9</th>\n",
              "      <td>user_pseudo_id</td>\n",
              "      <td>STRING</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>10</th>\n",
              "      <td>privacy_info</td>\n",
              "      <td>STRUCT&lt;analytics_storage INT64, ads_storage IN...</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>11</th>\n",
              "      <td>user_properties</td>\n",
              "      <td>ARRAY&lt;STRUCT&lt;key INT64, value STRUCT&lt;string_va...</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>12</th>\n",
              "      <td>user_first_touch_timestamp</td>\n",
              "      <td>INT64</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>13</th>\n",
              "      <td>user_ltv</td>\n",
              "      <td>STRUCT&lt;revenue FLOAT64, currency STRING&gt;</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>14</th>\n",
              "      <td>device</td>\n",
              "      <td>STRUCT&lt;category STRING, mobile_brand_name STRI...</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>15</th>\n",
              "      <td>geo</td>\n",
              "      <td>STRUCT&lt;continent STRING, sub_continent STRING,...</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>16</th>\n",
              "      <td>app_info</td>\n",
              "      <td>STRUCT&lt;id STRING, version STRING, install_stor...</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>17</th>\n",
              "      <td>traffic_source</td>\n",
              "      <td>STRUCT&lt;medium STRING, name STRING, source STRING&gt;</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>18</th>\n",
              "      <td>stream_id</td>\n",
              "      <td>INT64</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>19</th>\n",
              "      <td>platform</td>\n",
              "      <td>STRING</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>20</th>\n",
              "      <td>event_dimensions</td>\n",
              "      <td>STRUCT&lt;hostname STRING&gt;</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>21</th>\n",
              "      <td>ecommerce</td>\n",
              "      <td>STRUCT&lt;total_item_quantity INT64, purchase_rev...</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>22</th>\n",
              "      <td>items</td>\n",
              "      <td>ARRAY&lt;STRUCT&lt;item_id STRING, item_name STRING,...</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>\n",
              "      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-10be005d-420f-4e03-a406-40060d4ac8a0')\"\n",
              "              title=\"Convert this dataframe to an interactive table.\"\n",
              "              style=\"display:none;\">\n",
              "        \n",
              "  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n",
              "       width=\"24px\">\n",
              "    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n",
              "    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n",
              "  </svg>\n",
              "      </button>\n",
              "      \n",
              "  <style>\n",
              "    .colab-df-container {\n",
              "      display:flex;\n",
              "      flex-wrap:wrap;\n",
              "      gap: 12px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert {\n",
              "      background-color: #E8F0FE;\n",
              "      border: none;\n",
              "      border-radius: 50%;\n",
              "      cursor: pointer;\n",
              "      display: none;\n",
              "      fill: #1967D2;\n",
              "      height: 32px;\n",
              "      padding: 0 0 0 0;\n",
              "      width: 32px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert:hover {\n",
              "      background-color: #E2EBFA;\n",
              "      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n",
              "      fill: #174EA6;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert {\n",
              "      background-color: #3B4455;\n",
              "      fill: #D2E3FC;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert:hover {\n",
              "      background-color: #434B5C;\n",
              "      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n",
              "      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n",
              "      fill: #FFFFFF;\n",
              "    }\n",
              "  </style>\n",
              "\n",
              "      <script>\n",
              "        const buttonEl =\n",
              "          document.querySelector('#df-10be005d-420f-4e03-a406-40060d4ac8a0 button.colab-df-convert');\n",
              "        buttonEl.style.display =\n",
              "          google.colab.kernel.accessAllowed ? 'block' : 'none';\n",
              "\n",
              "        async function convertToInteractive(key) {\n",
              "          const element = document.querySelector('#df-10be005d-420f-4e03-a406-40060d4ac8a0');\n",
              "          const dataTable =\n",
              "            await google.colab.kernel.invokeFunction('convertToInteractive',\n",
              "                                                     [key], {});\n",
              "          if (!dataTable) return;\n",
              "\n",
              "          const docLinkHtml = 'Like what you see? Visit the ' +\n",
              "            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n",
              "            + ' to learn more about interactive tables.';\n",
              "          element.innerHTML = '';\n",
              "          dataTable['output_type'] = 'display_data';\n",
              "          await google.colab.output.renderOutput(dataTable, element);\n",
              "          const docLink = document.createElement('div');\n",
              "          docLink.innerHTML = docLinkHtml;\n",
              "          element.appendChild(docLink);\n",
              "        }\n",
              "      </script>\n",
              "    </div>\n",
              "  </div>\n",
              "  "
            ]
          },
          "metadata": {},
          "execution_count": 17
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "You can start by understanding overall data by getting a quick summary of the data, namely - total events  (event_count), total users (user_count), total days in the data (day_count), and total registered users of the platform (registered_user_id).\n",
        "This can help you get a sense of the scale of data."
      ],
      "metadata": {
        "id": "G29DgyP4vjgV"
      },
      "id": "G29DgyP4vjgV"
    },
    {
      "cell_type": "code",
      "source": [
        "query = f\"\"\"\n",
        "\n",
        "SELECT\n",
        "  COUNT(*) AS event_count,\n",
        "  COUNT(DISTINCT user_pseudo_id) AS user_count,\n",
        "  COUNT(DISTINCT event_date) AS day_count,\n",
        "  COUNT(DISTINCT user_id) AS registered_user_id\n",
        "FROM\n",
        "  `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events*`\n",
        "\"\"\"\n",
        "query_job = client.query(query)\n",
        "top5_data = query_job.to_dataframe()\n",
        "top5_data"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 80
        },
        "id": "rYSCfLhr6dUl",
        "outputId": "0a8bff18-d5e1-4638-8085-565456cf6fbb"
      },
      "id": "rYSCfLhr6dUl",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "   event_count  user_count  day_count  registered_user_id\n",
              "0      4295584      270154         92                   0"
            ],
            "text/html": [
              "\n",
              "  <div id=\"df-391d2c77-6593-49da-9d23-a37a4911fc7a\">\n",
              "    <div class=\"colab-df-container\">\n",
              "      <div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>event_count</th>\n",
              "      <th>user_count</th>\n",
              "      <th>day_count</th>\n",
              "      <th>registered_user_id</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>4295584</td>\n",
              "      <td>270154</td>\n",
              "      <td>92</td>\n",
              "      <td>0</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>\n",
              "      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-391d2c77-6593-49da-9d23-a37a4911fc7a')\"\n",
              "              title=\"Convert this dataframe to an interactive table.\"\n",
              "              style=\"display:none;\">\n",
              "        \n",
              "  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n",
              "       width=\"24px\">\n",
              "    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n",
              "    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n",
              "  </svg>\n",
              "      </button>\n",
              "      \n",
              "  <style>\n",
              "    .colab-df-container {\n",
              "      display:flex;\n",
              "      flex-wrap:wrap;\n",
              "      gap: 12px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert {\n",
              "      background-color: #E8F0FE;\n",
              "      border: none;\n",
              "      border-radius: 50%;\n",
              "      cursor: pointer;\n",
              "      display: none;\n",
              "      fill: #1967D2;\n",
              "      height: 32px;\n",
              "      padding: 0 0 0 0;\n",
              "      width: 32px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert:hover {\n",
              "      background-color: #E2EBFA;\n",
              "      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n",
              "      fill: #174EA6;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert {\n",
              "      background-color: #3B4455;\n",
              "      fill: #D2E3FC;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert:hover {\n",
              "      background-color: #434B5C;\n",
              "      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n",
              "      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n",
              "      fill: #FFFFFF;\n",
              "    }\n",
              "  </style>\n",
              "\n",
              "      <script>\n",
              "        const buttonEl =\n",
              "          document.querySelector('#df-391d2c77-6593-49da-9d23-a37a4911fc7a button.colab-df-convert');\n",
              "        buttonEl.style.display =\n",
              "          google.colab.kernel.accessAllowed ? 'block' : 'none';\n",
              "\n",
              "        async function convertToInteractive(key) {\n",
              "          const element = document.querySelector('#df-391d2c77-6593-49da-9d23-a37a4911fc7a');\n",
              "          const dataTable =\n",
              "            await google.colab.kernel.invokeFunction('convertToInteractive',\n",
              "                                                     [key], {});\n",
              "          if (!dataTable) return;\n",
              "\n",
              "          const docLinkHtml = 'Like what you see? Visit the ' +\n",
              "            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n",
              "            + ' to learn more about interactive tables.';\n",
              "          element.innerHTML = '';\n",
              "          dataTable['output_type'] = 'display_data';\n",
              "          await google.colab.output.renderOutput(dataTable, element);\n",
              "          const docLink = document.createElement('div');\n",
              "          docLink.innerHTML = docLinkHtml;\n",
              "          element.appendChild(docLink);\n",
              "        }\n",
              "      </script>\n",
              "    </div>\n",
              "  </div>\n",
              "  "
            ]
          },
          "metadata": {},
          "execution_count": 11
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "As you can observe, there are roughly 4 million events with close to 270,000 users, stretched along 92 days of activity on the platform.\n",
        "\n",
        "There are no registered users data in the table. The user_pseudo_id is not a \"user_id\"; it is an client ID (cookie ID) for the user. This means that a single user can be represented as multiple pseudo_id in the data.\n",
        "\n",
        "For simplicity, we will assume that all user_pseudo_id are unique and represent a single user.\n",
        "\n",
        "If your data has 'user_id', use that directly, or else you can go ahead and use 'user_psuudo_id'.\n"
      ],
      "metadata": {
        "id": "trhmmrbiS334"
      },
      "id": "trhmmrbiS334"
    },
    {
      "cell_type": "markdown",
      "source": [
        "Some potential columns of interest are already identified in our exploration, like - event_date, event_name, user_ltv, device, geo, traffic_source, platform, and items. As the pattern advances, the next goal is to explore event_name & event_params in more detail and their value distribution and availability. The other columns can be skipped from EDA for simplicity and assumed essential for features. However, it would be best if you carried the EDA for all possible candidates in the real world."
      ],
      "metadata": {
        "id": "37fx1NhXMINA"
      },
      "id": "37fx1NhXMINA"
    },
    {
      "cell_type": "markdown",
      "source": [
        "\n",
        "\n",
        "---\n",
        "Now, you can start by looking into `event_name` distribution.\n",
        "\n",
        "event_name is a significant column in this dataset. It contains all the events triggered as users interact with the Google Merchandise Store like page_view, scroll (scrolling the page), view_item (viewing specific item), etc. You can refer [here](https://developers.google.com/analytics/devguides/collection/ga4/reference/events) for a more detailed meaning of each event_name.\n"
      ],
      "metadata": {
        "id": "J4a69In4lqMh"
      },
      "id": "J4a69In4lqMh"
    },
    {
      "cell_type": "code",
      "source": [
        "query = f\"\"\"\n",
        "SELECT\n",
        "  event_name,\n",
        "  COUNT(*) as row_count\n",
        "FROM\n",
        "   `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events*`\n",
        "GROUP BY\n",
        "  event_name\n",
        "ORDER BY\n",
        "  row_count DESC\n",
        "\"\"\"\n",
        "query_job = client.query(query)\n",
        "result_df = query_job.to_dataframe()\n",
        "fig = px.bar(result_df, x=\"row_count\", y=\"event_name\",  title=\"Event Name Frequency Distribution\")\n",
        "fig.show()"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 542
        },
        "id": "DbiCdEaxMCBY",
        "outputId": "5656f105-e6b2-4ba6-e8bd-3ee3349450d4"
      },
      "id": "DbiCdEaxMCBY",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "display_data",
          "data": {
            "text/html": [
              "<html>\n",
              "<head><meta charset=\"utf-8\" /></head>\n",
              "<body>\n",
              "    <div>            <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG\"></script><script type=\"text/javascript\">if (window.MathJax) {MathJax.Hub.Config({SVG: {font: \"STIX-Web\"}});}</script>                <script type=\"text/javascript\">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>\n",
              "        <script src=\"https://cdn.plot.ly/plotly-2.8.3.min.js\"></script>                <div id=\"654ff65c-d536-40bf-a5e4-b55a93b28b15\" class=\"plotly-graph-div\" style=\"height:525px; width:100%;\"></div>            <script type=\"text/javascript\">                                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById(\"654ff65c-d536-40bf-a5e4-b55a93b28b15\")) {                    Plotly.newPlot(                        \"654ff65c-d536-40bf-a5e4-b55a93b28b15\",                        [{\"alignmentgroup\":\"True\",\"hovertemplate\":\"row_count=%{x}<br>event_name=%{y}<extra></extra>\",\"legendgroup\":\"\",\"marker\":{\"color\":\"#636efa\",\"pattern\":{\"shape\":\"\"}},\"name\":\"\",\"offsetgroup\":\"\",\"orientation\":\"h\",\"showlegend\":false,\"textposition\":\"auto\",\"x\":[1350428,1058721,493072,386068,354970,257462,190104,58543,38757,31007,26172,19722,13899,9450,5692,1446,71],\"xaxis\":\"x\",\"y\":[\"page_view\",\"user_engagement\",\"scroll\",\"view_item\",\"session_start\",\"first_visit\",\"view_promotion\",\"add_to_cart\",\"begin_checkout\",\"select_item\",\"view_search_results\",\"add_shipping_info\",\"add_payment_info\",\"select_promotion\",\"purchase\",\"click\",\"view_item_list\"],\"yaxis\":\"y\",\"type\":\"bar\"}],                        {\"template\":{\"data\":{\"bar\":[{\"error_x\":{\"color\":\"#2a3f5f\"},\"error_y\":{\"color\":\"#2a3f5f\"},\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"bar\"}],\"barpolar\":[{\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"barpolar\"}],\"carpet\":[{\"aaxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"baxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"type\":\"carpet\"}],\"choropleth\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"choropleth\"}],\"contour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"contour\"}],\"contourcarpet\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"contourcarpet\"}],\"heatmap\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmap\"}],\"heatmapgl\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmapgl\"}],\"histogram\":[{\"marker\":{\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"histogram\"}],\"histogram2d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2d\"}],\"histogram2dcontour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2dcontour\"}],\"mesh3d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"mesh3d\"}],\"parcoords\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"parcoords\"}],\"pie\":[{\"automargin\":true,\"type\":\"pie\"}],\"scatter\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter\"}],\"scatter3d\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter3d\"}],\"scattercarpet\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattercarpet\"}],\"scattergeo\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergeo\"}],\"scattergl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergl\"}],\"scattermapbox\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattermapbox\"}],\"scatterpolar\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolar\"}],\"scatterpolargl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolargl\"}],\"scatterternary\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterternary\"}],\"surface\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"surface\"}],\"table\":[{\"cells\":{\"fill\":{\"color\":\"#EBF0F8\"},\"line\":{\"color\":\"white\"}},\"header\":{\"fill\":{\"color\":\"#C8D4E3\"},\"line\":{\"color\":\"white\"}},\"type\":\"table\"}]},\"layout\":{\"annotationdefaults\":{\"arrowcolor\":\"#2a3f5f\",\"arrowhead\":0,\"arrowwidth\":1},\"autotypenumbers\":\"strict\",\"coloraxis\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"colorscale\":{\"diverging\":[[0,\"#8e0152\"],[0.1,\"#c51b7d\"],[0.2,\"#de77ae\"],[0.3,\"#f1b6da\"],[0.4,\"#fde0ef\"],[0.5,\"#f7f7f7\"],[0.6,\"#e6f5d0\"],[0.7,\"#b8e186\"],[0.8,\"#7fbc41\"],[0.9,\"#4d9221\"],[1,\"#276419\"]],\"sequential\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"sequentialminus\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]},\"colorway\":[\"#636efa\",\"#EF553B\",\"#00cc96\",\"#ab63fa\",\"#FFA15A\",\"#19d3f3\",\"#FF6692\",\"#B6E880\",\"#FF97FF\",\"#FECB52\"],\"font\":{\"color\":\"#2a3f5f\"},\"geo\":{\"bgcolor\":\"white\",\"lakecolor\":\"white\",\"landcolor\":\"#E5ECF6\",\"showlakes\":true,\"showland\":true,\"subunitcolor\":\"white\"},\"hoverlabel\":{\"align\":\"left\"},\"hovermode\":\"closest\",\"mapbox\":{\"style\":\"light\"},\"paper_bgcolor\":\"white\",\"plot_bgcolor\":\"#E5ECF6\",\"polar\":{\"angularaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"radialaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"scene\":{\"xaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"yaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"zaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"}},\"shapedefaults\":{\"line\":{\"color\":\"#2a3f5f\"}},\"ternary\":{\"aaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"baxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"caxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"title\":{\"x\":0.05},\"xaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2},\"yaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2}}},\"xaxis\":{\"anchor\":\"y\",\"domain\":[0.0,1.0],\"title\":{\"text\":\"row_count\"}},\"yaxis\":{\"anchor\":\"x\",\"domain\":[0.0,1.0],\"title\":{\"text\":\"event_name\"}},\"legend\":{\"tracegroupgap\":0},\"title\":{\"text\":\"Event Name Frequency Distribution\"},\"barmode\":\"relative\"},                        {\"responsive\": true}                    ).then(function(){\n",
              "                            \n",
              "var gd = document.getElementById('654ff65c-d536-40bf-a5e4-b55a93b28b15');\n",
              "var x = new MutationObserver(function (mutations, observer) {{\n",
              "        var display = window.getComputedStyle(gd).display;\n",
              "        if (!display || display === 'none') {{\n",
              "            console.log([gd, 'removed!']);\n",
              "            Plotly.purge(gd);\n",
              "            observer.disconnect();\n",
              "        }}\n",
              "}});\n",
              "\n",
              "// Listen for the removal of the full notebook cells\n",
              "var notebookContainer = gd.closest('#notebook-container');\n",
              "if (notebookContainer) {{\n",
              "    x.observe(notebookContainer, {childList: true});\n",
              "}}\n",
              "\n",
              "// Listen for the clearing of the current output cell\n",
              "var outputEl = gd.closest('.output');\n",
              "if (outputEl) {{\n",
              "    x.observe(outputEl, {childList: true});\n",
              "}}\n",
              "\n",
              "                        })                };                            </script>        </div>\n",
              "</body>\n",
              "</html>"
            ]
          },
          "metadata": {}
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "You can observe a great imbalance in the frequency of different event_name(s). The top five events based on frequency:\n",
        "\n",
        "* page_view - User is viewing a page\n",
        "\n",
        "* user_engagement - Sessions that last 10 seconds or longer\n",
        "\n",
        "* scroll - User scrolling through a page\n",
        "\n",
        "* view_item - some content was shown to the user. You can use this to discover the most popular items.\n",
        "\n",
        "* session_start - User session after the engagement has been initiated.\n",
        "\n",
        "\n",
        "The other events don't have too many records and hence would be a challenge to be considered a feature. However, you can also notice that typical purchase events - \"add_to_cart\", \"begin_checkout\", \"add_shipping_info\", \"add_payment_info\", and \"purchase\" have a tiny amount of records, indicating that this data doesn't contain too many events where a user has bought something.\n",
        "\n",
        "\n",
        "So,`page_view` seems to be the best filter for the column `event_name` since it has the highest records and covers users' general browsing behavior. However, you can still leverage `add_to_cart` and `purchase` value for purchase information by simply counting a user's total events for these event types. So, although they will be small, you can include them for demonstration purposes to add a little more diversification in the data for the K-Means Model.\n",
        "\n",
        "Also, remember that the actual key of `page_view` event_name is available in event_params, and their values are in event_params.values.{int/float/string} in nested array format.\n",
        "\n",
        "Data references:\n",
        "\n",
        "[Dimensions & Metrics](https://support.google.com/analytics/topic/11151952?hl=en&ref_topic=9228654)\n"
      ],
      "metadata": {
        "id": "m1spMS_ysKE0"
      },
      "id": "m1spMS_ysKE0"
    },
    {
      "cell_type": "markdown",
      "source": [
        "\n",
        "\n",
        "---\n",
        "\n",
        "Next, you can explore event_params. There are multiple `event_params`  (shown in image) for each `event_name` ( like page_view) that stores the information for that event. It is a nested array and would require UNNEST function to access its key and different values (string, int, and float)."
      ],
      "metadata": {
        "id": "LAmRM2EwyCA8"
      },
      "id": "LAmRM2EwyCA8"
    },
    {
      "cell_type": "markdown",
      "source": [
        "![](https://screenshot.googleplex.com/XVbxmw68LKDsFxz.png)"
      ],
      "metadata": {
        "id": "LzYGWfcJRXKM"
      },
      "id": "LzYGWfcJRXKM"
    },
    {
      "cell_type": "markdown",
      "source": [
        "If you are unsure of the GA4 export schema; please refer [here](https://support.google.com/analytics/answer/3437719?hl=en)."
      ],
      "metadata": {
        "id": "-M9H3Vs2SAmP"
      },
      "id": "-M9H3Vs2SAmP"
    },
    {
      "cell_type": "code",
      "source": [
        "query = f\"\"\"\n",
        "SELECT\n",
        "  DISTINCT(ep.key) AS event_param_key,\n",
        "  COUNT(*) AS count\n",
        "FROM\n",
        "  `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events*`,\n",
        "  UNNEST (event_params) AS ep\n",
        "WHERE\n",
        "  event_name = 'page_view'\n",
        "GROUP BY\n",
        "  ep.key\n",
        "ORDER BY\n",
        "  count DESC\n",
        "\"\"\"\n",
        "query_job = client.query(query)\n",
        "result_df = query_job.to_dataframe()\n",
        "\n",
        "fig = px.bar(result_df.head(20), x=\"count\", y=\"event_param_key\",  title=\"Event Parameters in Various Events Frequency Distribution\")\n",
        "fig.show()"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 542
        },
        "id": "W4NbomfU2LBZ",
        "outputId": "96047abc-2f4d-406d-9e66-7b123f899788"
      },
      "id": "W4NbomfU2LBZ",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "display_data",
          "data": {
            "text/html": [
              "<html>\n",
              "<head><meta charset=\"utf-8\" /></head>\n",
              "<body>\n",
              "    <div>            <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG\"></script><script type=\"text/javascript\">if (window.MathJax) {MathJax.Hub.Config({SVG: {font: \"STIX-Web\"}});}</script>                <script type=\"text/javascript\">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>\n",
              "        <script src=\"https://cdn.plot.ly/plotly-2.8.3.min.js\"></script>                <div id=\"3b982241-429d-4eaa-84bd-16de13114ea9\" class=\"plotly-graph-div\" style=\"height:525px; width:100%;\"></div>            <script type=\"text/javascript\">                                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById(\"3b982241-429d-4eaa-84bd-16de13114ea9\")) {                    Plotly.newPlot(                        \"3b982241-429d-4eaa-84bd-16de13114ea9\",                        [{\"alignmentgroup\":\"True\",\"hovertemplate\":\"count=%{x}<br>event_param_key=%{y}<extra></extra>\",\"legendgroup\":\"\",\"marker\":{\"color\":\"#636efa\",\"pattern\":{\"shape\":\"\"}},\"name\":\"\",\"offsetgroup\":\"\",\"orientation\":\"h\",\"showlegend\":false,\"textposition\":\"auto\",\"x\":[4295584,4295584,4295584,4276104,4116237,3996312,3682991,3206512,2828174,2828040,2431818,1439214,1439167,1428080,493072,338704,332179,118481,116846,39313],\"xaxis\":\"x\",\"y\":[\"page_location\",\"ga_session_number\",\"ga_session_id\",\"page_title\",\"engaged_session_event\",\"session_engaged\",\"debug_mode\",\"page_referrer\",\"all_data\",\"clean_event\",\"engagement_time_msec\",\"medium\",\"campaign\",\"source\",\"percent_scrolled\",\"term\",\"entrances\",\"gclid\",\"gclsrc\",\"currency\"],\"yaxis\":\"y\",\"type\":\"bar\"}],                        {\"template\":{\"data\":{\"bar\":[{\"error_x\":{\"color\":\"#2a3f5f\"},\"error_y\":{\"color\":\"#2a3f5f\"},\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"bar\"}],\"barpolar\":[{\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"barpolar\"}],\"carpet\":[{\"aaxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"baxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"type\":\"carpet\"}],\"choropleth\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"choropleth\"}],\"contour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"contour\"}],\"contourcarpet\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"contourcarpet\"}],\"heatmap\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmap\"}],\"heatmapgl\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmapgl\"}],\"histogram\":[{\"marker\":{\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"histogram\"}],\"histogram2d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2d\"}],\"histogram2dcontour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2dcontour\"}],\"mesh3d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"mesh3d\"}],\"parcoords\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"parcoords\"}],\"pie\":[{\"automargin\":true,\"type\":\"pie\"}],\"scatter\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter\"}],\"scatter3d\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter3d\"}],\"scattercarpet\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattercarpet\"}],\"scattergeo\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergeo\"}],\"scattergl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergl\"}],\"scattermapbox\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattermapbox\"}],\"scatterpolar\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolar\"}],\"scatterpolargl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolargl\"}],\"scatterternary\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterternary\"}],\"surface\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"surface\"}],\"table\":[{\"cells\":{\"fill\":{\"color\":\"#EBF0F8\"},\"line\":{\"color\":\"white\"}},\"header\":{\"fill\":{\"color\":\"#C8D4E3\"},\"line\":{\"color\":\"white\"}},\"type\":\"table\"}]},\"layout\":{\"annotationdefaults\":{\"arrowcolor\":\"#2a3f5f\",\"arrowhead\":0,\"arrowwidth\":1},\"autotypenumbers\":\"strict\",\"coloraxis\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"colorscale\":{\"diverging\":[[0,\"#8e0152\"],[0.1,\"#c51b7d\"],[0.2,\"#de77ae\"],[0.3,\"#f1b6da\"],[0.4,\"#fde0ef\"],[0.5,\"#f7f7f7\"],[0.6,\"#e6f5d0\"],[0.7,\"#b8e186\"],[0.8,\"#7fbc41\"],[0.9,\"#4d9221\"],[1,\"#276419\"]],\"sequential\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"sequentialminus\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]},\"colorway\":[\"#636efa\",\"#EF553B\",\"#00cc96\",\"#ab63fa\",\"#FFA15A\",\"#19d3f3\",\"#FF6692\",\"#B6E880\",\"#FF97FF\",\"#FECB52\"],\"font\":{\"color\":\"#2a3f5f\"},\"geo\":{\"bgcolor\":\"white\",\"lakecolor\":\"white\",\"landcolor\":\"#E5ECF6\",\"showlakes\":true,\"showland\":true,\"subunitcolor\":\"white\"},\"hoverlabel\":{\"align\":\"left\"},\"hovermode\":\"closest\",\"mapbox\":{\"style\":\"light\"},\"paper_bgcolor\":\"white\",\"plot_bgcolor\":\"#E5ECF6\",\"polar\":{\"angularaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"radialaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"scene\":{\"xaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"yaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"zaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"}},\"shapedefaults\":{\"line\":{\"color\":\"#2a3f5f\"}},\"ternary\":{\"aaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"baxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"caxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"title\":{\"x\":0.05},\"xaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2},\"yaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2}}},\"xaxis\":{\"anchor\":\"y\",\"domain\":[0.0,1.0],\"title\":{\"text\":\"count\"}},\"yaxis\":{\"anchor\":\"x\",\"domain\":[0.0,1.0],\"title\":{\"text\":\"event_param_key\"}},\"legend\":{\"tracegroupgap\":0},\"title\":{\"text\":\"Event Parameters in Various Events Frequency Distribution\"},\"barmode\":\"relative\"},                        {\"responsive\": true}                    ).then(function(){\n",
              "                            \n",
              "var gd = document.getElementById('3b982241-429d-4eaa-84bd-16de13114ea9');\n",
              "var x = new MutationObserver(function (mutations, observer) {{\n",
              "        var display = window.getComputedStyle(gd).display;\n",
              "        if (!display || display === 'none') {{\n",
              "            console.log([gd, 'removed!']);\n",
              "            Plotly.purge(gd);\n",
              "            observer.disconnect();\n",
              "        }}\n",
              "}});\n",
              "\n",
              "// Listen for the removal of the full notebook cells\n",
              "var notebookContainer = gd.closest('#notebook-container');\n",
              "if (notebookContainer) {{\n",
              "    x.observe(notebookContainer, {childList: true});\n",
              "}}\n",
              "\n",
              "// Listen for the clearing of the current output cell\n",
              "var outputEl = gd.closest('.output');\n",
              "if (outputEl) {{\n",
              "    x.observe(outputEl, {childList: true});\n",
              "}}\n",
              "\n",
              "                        })                };                            </script>        </div>\n",
              "</body>\n",
              "</html>"
            ]
          },
          "metadata": {}
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "In this graph, you can observe many `key` are part of event_name or a specific event type (like page_view). Moreover, you can also see their respective distributions, which can help us decide which key's to pick for our features.\n",
        "\n",
        "Among all, the following three will make sense for our current modeling:\n",
        "- page_title: page visited by a user.\n",
        "- campaign: if user event has been triggered by some campaigns.\n",
        "- engagement_time_msec: user engagement time in millisecond for the event.\n",
        "\n",
        "They will help us define user behavior on the platform. Like:\n",
        "\n",
        "- page_title can give us a view into user interest based on their browsing history,\n",
        "- campaigns can help us identify how users are engaging with the platform, and\n",
        "- engagement times can help us understand their browsing intensity.\n",
        "\n",
        "These features, together with others, can help diversify clusters. Remember, the more distinct values you have in features, the better for K-means models to segment users in different clusters.\n",
        "\n",
        "Also, one thing to note here is that we will stick to one `event_type` for these keys: ' page_view`.\n",
        "\n",
        "You can pick the others based on your business objectives and requirements, but we will stick with these for simplicity."
      ],
      "metadata": {
        "id": "WsgvT6T34RZP"
      },
      "id": "WsgvT6T34RZP"
    },
    {
      "cell_type": "markdown",
      "source": [
        "\n",
        "\n",
        "---\n",
        "\n",
        "The next feature to look into is page_title. For all page_view that you filter, which a user is browsing, you can also see the page's title. This information can give you enough detail about their interest. However, a user can browse through thousands of pages, and it will be tough to find any relevant information from all of them at once.\n",
        "\n",
        "One neat way would be to find out the top most visited pages across all users and then rank each user against those pages. Like, top pages may have a title like - \"Apparel,\" \"Bags,\" \"Stationary,\" etc.\n",
        "\n",
        "In the below query, you can get the count of top most visited pages and then plot them to see the distribution.\n"
      ],
      "metadata": {
        "id": "qmALuOkXBaYk"
      },
      "id": "qmALuOkXBaYk"
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "ab9d14aa-2013-46df-b400-89a6cb63927f",
      "metadata": {
        "id": "ab9d14aa-2013-46df-b400-89a6cb63927f"
      },
      "outputs": [],
      "source": [
        "query = \"\"\"\n",
        "SELECT\n",
        "  DISTINCT (ep.value.string_value) AS page_title,\n",
        "  COUNT(*) AS page_title_count\n",
        "FROM\n",
        "  `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`,\n",
        "  UNNEST (event_params) AS ep\n",
        "WHERE\n",
        "  ep.key = 'page_title'\n",
        "  AND event_name = 'page_view'\n",
        "GROUP BY\n",
        "  page_title\n",
        "ORDER BY\n",
        "  page_title_count DESC\n",
        "LIMIT\n",
        "20\n",
        "\"\"\"\n",
        "query_job = client.query(query)\n",
        "page_title_result_df = query_job.to_dataframe()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "a32557f6-d796-4d85-81e2-390c7105d1da",
      "metadata": {
        "id": "a32557f6-d796-4d85-81e2-390c7105d1da",
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 542
        },
        "outputId": "0f28c312-6a74-46f3-ea48-3a39a8f2cf50"
      },
      "outputs": [
        {
          "output_type": "display_data",
          "data": {
            "text/html": [
              "<html>\n",
              "<head><meta charset=\"utf-8\" /></head>\n",
              "<body>\n",
              "    <div>            <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG\"></script><script type=\"text/javascript\">if (window.MathJax) {MathJax.Hub.Config({SVG: {font: \"STIX-Web\"}});}</script>                <script type=\"text/javascript\">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>\n",
              "        <script src=\"https://cdn.plot.ly/plotly-2.8.3.min.js\"></script>                <div id=\"c9677a9b-3865-4d4f-ab8e-c0a581948a84\" class=\"plotly-graph-div\" style=\"height:525px; width:100%;\"></div>            <script type=\"text/javascript\">                                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById(\"c9677a9b-3865-4d4f-ab8e-c0a581948a84\")) {                    Plotly.newPlot(                        \"c9677a9b-3865-4d4f-ab8e-c0a581948a84\",                        [{\"alignmentgroup\":\"True\",\"hovertemplate\":\"page_title_count=%{x}<br>page_title=%{y}<extra></extra>\",\"legendgroup\":\"\",\"marker\":{\"color\":\"#636efa\",\"pattern\":{\"shape\":\"\"}},\"name\":\"\",\"offsetgroup\":\"\",\"orientation\":\"h\",\"showlegend\":false,\"textposition\":\"auto\",\"x\":[256778,104548,81697,78888,47774,46388,40361,38334,28506,27476,27316,25617,22476,22176,20902,19706,19312,19249,17861,17738],\"xaxis\":\"x\",\"y\":[\"Home\",\"Google Online Store\",\"Apparel | Google Merchandise Store\",\"Shopping Cart\",\"The Google Merchandise Store - Log In\",\"Men's / Unisex | Apparel | Google Merchandise Store\",\"YouTube | Shop by Brand | Google Merchandise Store\",\"Sale | Google Merchandise Store\",\"New | Google Merchandise Store\",\"Google Dino Game Tee\",\"Store search results\",\"Drinkware | Lifestyle | Google Merchandise Store\",\"Bags | Lifestyle | Google Merchandise Store\",\"Page Unavailable\",\"Campus Collection | Google Merchandise Store\",\"Checkout Your Information\",\"Eco-Friendly | Google Merchandise Store\",\"Hats | Apparel | Google Merchandise Store\",\"The Google Merchandise Store - My Account\",\"Womens | Apparel | Google Merchandise Store\"],\"yaxis\":\"y\",\"type\":\"bar\"}],                        {\"template\":{\"data\":{\"bar\":[{\"error_x\":{\"color\":\"#2a3f5f\"},\"error_y\":{\"color\":\"#2a3f5f\"},\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"bar\"}],\"barpolar\":[{\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"barpolar\"}],\"carpet\":[{\"aaxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"baxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"type\":\"carpet\"}],\"choropleth\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"choropleth\"}],\"contour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"contour\"}],\"contourcarpet\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"contourcarpet\"}],\"heatmap\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmap\"}],\"heatmapgl\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmapgl\"}],\"histogram\":[{\"marker\":{\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"histogram\"}],\"histogram2d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2d\"}],\"histogram2dcontour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2dcontour\"}],\"mesh3d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"mesh3d\"}],\"parcoords\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"parcoords\"}],\"pie\":[{\"automargin\":true,\"type\":\"pie\"}],\"scatter\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter\"}],\"scatter3d\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter3d\"}],\"scattercarpet\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattercarpet\"}],\"scattergeo\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergeo\"}],\"scattergl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergl\"}],\"scattermapbox\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattermapbox\"}],\"scatterpolar\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolar\"}],\"scatterpolargl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolargl\"}],\"scatterternary\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterternary\"}],\"surface\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"surface\"}],\"table\":[{\"cells\":{\"fill\":{\"color\":\"#EBF0F8\"},\"line\":{\"color\":\"white\"}},\"header\":{\"fill\":{\"color\":\"#C8D4E3\"},\"line\":{\"color\":\"white\"}},\"type\":\"table\"}]},\"layout\":{\"annotationdefaults\":{\"arrowcolor\":\"#2a3f5f\",\"arrowhead\":0,\"arrowwidth\":1},\"autotypenumbers\":\"strict\",\"coloraxis\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"colorscale\":{\"diverging\":[[0,\"#8e0152\"],[0.1,\"#c51b7d\"],[0.2,\"#de77ae\"],[0.3,\"#f1b6da\"],[0.4,\"#fde0ef\"],[0.5,\"#f7f7f7\"],[0.6,\"#e6f5d0\"],[0.7,\"#b8e186\"],[0.8,\"#7fbc41\"],[0.9,\"#4d9221\"],[1,\"#276419\"]],\"sequential\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"sequentialminus\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]},\"colorway\":[\"#636efa\",\"#EF553B\",\"#00cc96\",\"#ab63fa\",\"#FFA15A\",\"#19d3f3\",\"#FF6692\",\"#B6E880\",\"#FF97FF\",\"#FECB52\"],\"font\":{\"color\":\"#2a3f5f\"},\"geo\":{\"bgcolor\":\"white\",\"lakecolor\":\"white\",\"landcolor\":\"#E5ECF6\",\"showlakes\":true,\"showland\":true,\"subunitcolor\":\"white\"},\"hoverlabel\":{\"align\":\"left\"},\"hovermode\":\"closest\",\"mapbox\":{\"style\":\"light\"},\"paper_bgcolor\":\"white\",\"plot_bgcolor\":\"#E5ECF6\",\"polar\":{\"angularaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"radialaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"scene\":{\"xaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"yaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"zaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"}},\"shapedefaults\":{\"line\":{\"color\":\"#2a3f5f\"}},\"ternary\":{\"aaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"baxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"caxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"title\":{\"x\":0.05},\"xaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2},\"yaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2}}},\"xaxis\":{\"anchor\":\"y\",\"domain\":[0.0,1.0],\"title\":{\"text\":\"page_title_count\"}},\"yaxis\":{\"anchor\":\"x\",\"domain\":[0.0,1.0],\"title\":{\"text\":\"page_title\"}},\"legend\":{\"tracegroupgap\":0},\"title\":{\"text\":\"Different Page Visited Frequency Distribution\"},\"barmode\":\"relative\"},                        {\"responsive\": true}                    ).then(function(){\n",
              "                            \n",
              "var gd = document.getElementById('c9677a9b-3865-4d4f-ab8e-c0a581948a84');\n",
              "var x = new MutationObserver(function (mutations, observer) {{\n",
              "        var display = window.getComputedStyle(gd).display;\n",
              "        if (!display || display === 'none') {{\n",
              "            console.log([gd, 'removed!']);\n",
              "            Plotly.purge(gd);\n",
              "            observer.disconnect();\n",
              "        }}\n",
              "}});\n",
              "\n",
              "// Listen for the removal of the full notebook cells\n",
              "var notebookContainer = gd.closest('#notebook-container');\n",
              "if (notebookContainer) {{\n",
              "    x.observe(notebookContainer, {childList: true});\n",
              "}}\n",
              "\n",
              "// Listen for the clearing of the current output cell\n",
              "var outputEl = gd.closest('.output');\n",
              "if (outputEl) {{\n",
              "    x.observe(outputEl, {childList: true});\n",
              "}}\n",
              "\n",
              "                        })                };                            </script>        </div>\n",
              "</body>\n",
              "</html>"
            ]
          },
          "metadata": {}
        }
      ],
      "source": [
        "fig = px.bar(page_title_result_df, x=\"page_title_count\", y=\"page_title\",  title=\"Different Page Visited Frequency Distribution\")\n",
        "fig.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "Based on the graph, you can pick four or five titles that can help with audience segmentation by adding that \"interest\" diversification, like:\n",
        "\n",
        "*   Apparel | Google Merchandise Store\n",
        "*   Bags | Lifestyle | Google Merchandise Store\n",
        "*   Hats | Apparel | Google Merchandise Store\n",
        "*   Women's | Apparel | Google Merchandise Store\n",
        "\n",
        "This analysis can help you identify above such important page_title. However, there is a big catch here. You would have to do this manually every time you are running audience segmentation, and it will significantly depend on the kind of data you have at your end.\n",
        "\n",
        "The other challenge is to identify the top N number for the selection. You may choose more since BQML would easily handle hundreds of columns, but it will still be your choice to find the best contender for your business objective.\n",
        "\n",
        "For this pattern, the goal is simple, and hence the focus is only to pick the top 4 or 5.\n",
        "\n",
        "In the next Feature Engineering section, we will see a way to automate this such that you wouldn't have to do this manually."
      ],
      "metadata": {
        "id": "ZJd7sucOBmPJ"
      },
      "id": "ZJd7sucOBmPJ"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Feature Engineering"
      ],
      "metadata": {
        "id": "1E_xbe1sdYkr"
      },
      "id": "1E_xbe1sdYkr"
    },
    {
      "cell_type": "markdown",
      "source": [
        "Now that you have done some basic exploration of GA4 data, you can create different features for audience segmentation.\n",
        "\n",
        "However, before doing that, you should create a Dataset in BQ Console named \"ga4_ecomm_feature_set\" inside your project. Then, you can create a table for different kinds of features and store in the dataset.\n",
        "\n",
        "\n",
        "This will help retain the features for later purposes."
      ],
      "metadata": {
        "id": "qi7BCwzx644F"
      },
      "id": "qi7BCwzx644F"
    },
    {
      "cell_type": "code",
      "source": [
        "# You can create the dataset through code.\n",
        "DATASET_NAME = \"ga4_ecomm_feature_set\"\n",
        "!bq mk $DATASET_NAME"
      ],
      "metadata": {
        "id": "cDVvVffhvSvC"
      },
      "id": "cDVvVffhvSvC",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "\n",
        "\n",
        "---\n",
        "\n"
      ],
      "metadata": {
        "id": "C3QPhd-5F6Qv"
      },
      "id": "C3QPhd-5F6Qv"
    },
    {
      "cell_type": "markdown",
      "source": [
        "The goal for feature engineering is to create four types of features for each user:\n",
        "\n",
        "1) page_title -> top browsing interest like Apparel_visit_count, Shopping_Cart_visit_count, Mens_visit_count, YouTube_visit_count and etc.\n",
        "\n",
        "2) page_view -> total browsing events\n",
        "\n",
        "3) purchase event (add_to_cart, purchase) -> total count of add_to_cart and purchase event\n",
        "\n",
        "4) user behavior -> aggregated values of user behaviors like; favorite browser, language, device, etc., or most used country, currency, and engagement time."
      ],
      "metadata": {
        "id": "Spbo4k1e111j"
      },
      "id": "Spbo4k1e111j"
    },
    {
      "cell_type": "markdown",
      "source": [
        "page_title contains the page's title viewed during the page_view (browsing) event. For example, the user might be visiting the \"Apparel\" page or \"Bags\" page. This information can generally give users interest in various products offered on the website.\n",
        "\n",
        "However, there can be thousands of products and their respective page_tile in a data; hence to simplify, you can only look into the top viewed page and check users' frequency for those specific pages. You can name other page_title as \"others\" and only keep top_n_for_page_title for feature extraction.\n",
        "\n",
        "You can also include an exclude list while querying the top pages based on your N value. This will keep away the most obvious pages from your selection. For example, the \"Home\" page or other pages that doesn't give any specific interest or user behavior."
      ],
      "metadata": {
        "id": "VpZacXEkQGWJ"
      },
      "id": "VpZacXEkQGWJ"
    },
    {
      "cell_type": "code",
      "source": [
        "exclude_list = ('Home','Google Online Store')\n",
        "top_n = 20\n",
        "#query to get page_title frequency for all pages visited.\n",
        "query = f\"\"\"\n",
        "WITH\n",
        "  top_viewed_pages AS (\n",
        "  SELECT\n",
        "    DISTINCT (ep.value.string_value) AS page_title,\n",
        "    REGEXP_REPLACE(REPLACE(TRIM(SPLIT(ep.value.string_value, \"|\")[SAFE_OFFSET(0)]), \" \", \"_\"), r'[^a-zA-Z]', '') AS key,\n",
        "    COUNT(*) AS page_title_count,\n",
        "  FROM\n",
        "    `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events_*`,\n",
        "    UNNEST (event_params) AS ep\n",
        "  WHERE\n",
        "    ep.key = 'page_title'\n",
        "  GROUP BY\n",
        "    page_title\n",
        "  ORDER BY\n",
        "    page_title_count DESC\n",
        "  LIMIT\n",
        "    {top_n} )\n",
        "SELECT\n",
        "  *\n",
        "FROM\n",
        "  top_viewed_pages\n",
        "WHERE\n",
        "  page_title NOT IN {exclude_list}\n",
        "\"\"\"\n",
        "query_job = client.query(query)\n",
        "df = query_job.to_dataframe()\n",
        "df"
      ],
      "metadata": {
        "id": "rp1OI-FsGkhd",
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 614
        },
        "outputId": "da22aa64-7ad4-4918-b2d3-1afa0416842c"
      },
      "id": "rp1OI-FsGkhd",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "                                           page_title  \\\n",
              "0                  Apparel | Google Merchandise Store   \n",
              "1                                       Shopping Cart   \n",
              "2   Men's / Unisex | Apparel | Google Merchandise ...   \n",
              "3   YouTube | Shop by Brand | Google Merchandise S...   \n",
              "4                     Sale | Google Merchandise Store   \n",
              "5               The Google Merchandise Store - Log In   \n",
              "6                           Checkout Your Information   \n",
              "7                                Store search results   \n",
              "8                                Google Dino Game Tee   \n",
              "9    Drinkware | Lifestyle | Google Merchandise Store   \n",
              "10                     New | Google Merchandise Store   \n",
              "11        Bags | Lifestyle | Google Merchandise Store   \n",
              "12          Hats | Apparel | Google Merchandise Store   \n",
              "13        Womens | Apparel | Google Merchandise Store   \n",
              "14       Campus Collection | Google Merchandise Store   \n",
              "15                                   Page Unavailable   \n",
              "16            Eco-Friendly | Google Merchandise Store   \n",
              "17                                     Payment Method   \n",
              "\n",
              "                               key  page_title_count  \n",
              "0                          Apparel            235947  \n",
              "1                     ShoppingCart            195006  \n",
              "2                       MensUnisex            164270  \n",
              "3                          YouTube            137918  \n",
              "4                             Sale            131757  \n",
              "5   TheGoogleMerchandiseStoreLogIn            123091  \n",
              "6          CheckoutYourInformation            110781  \n",
              "7               Storesearchresults            102228  \n",
              "8                GoogleDinoGameTee             82167  \n",
              "9                        Drinkware             82156  \n",
              "10                             New             81977  \n",
              "11                            Bags             68674  \n",
              "12                            Hats             62171  \n",
              "13                          Womens             60667  \n",
              "14                CampusCollection             56129  \n",
              "15                 PageUnavailable             56030  \n",
              "16                     EcoFriendly             55492  \n",
              "17                   PaymentMethod             49803  "
            ],
            "text/html": [
              "\n",
              "  <div id=\"df-c870c7ae-9699-445a-9e62-39e14f80f51c\">\n",
              "    <div class=\"colab-df-container\">\n",
              "      <div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>page_title</th>\n",
              "      <th>key</th>\n",
              "      <th>page_title_count</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>Apparel | Google Merchandise Store</td>\n",
              "      <td>Apparel</td>\n",
              "      <td>235947</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>1</th>\n",
              "      <td>Shopping Cart</td>\n",
              "      <td>ShoppingCart</td>\n",
              "      <td>195006</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>2</th>\n",
              "      <td>Men's / Unisex | Apparel | Google Merchandise ...</td>\n",
              "      <td>MensUnisex</td>\n",
              "      <td>164270</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>3</th>\n",
              "      <td>YouTube | Shop by Brand | Google Merchandise S...</td>\n",
              "      <td>YouTube</td>\n",
              "      <td>137918</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>4</th>\n",
              "      <td>Sale | Google Merchandise Store</td>\n",
              "      <td>Sale</td>\n",
              "      <td>131757</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>5</th>\n",
              "      <td>The Google Merchandise Store - Log In</td>\n",
              "      <td>TheGoogleMerchandiseStoreLogIn</td>\n",
              "      <td>123091</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>6</th>\n",
              "      <td>Checkout Your Information</td>\n",
              "      <td>CheckoutYourInformation</td>\n",
              "      <td>110781</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>7</th>\n",
              "      <td>Store search results</td>\n",
              "      <td>Storesearchresults</td>\n",
              "      <td>102228</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>8</th>\n",
              "      <td>Google Dino Game Tee</td>\n",
              "      <td>GoogleDinoGameTee</td>\n",
              "      <td>82167</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>9</th>\n",
              "      <td>Drinkware | Lifestyle | Google Merchandise Store</td>\n",
              "      <td>Drinkware</td>\n",
              "      <td>82156</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>10</th>\n",
              "      <td>New | Google Merchandise Store</td>\n",
              "      <td>New</td>\n",
              "      <td>81977</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>11</th>\n",
              "      <td>Bags | Lifestyle | Google Merchandise Store</td>\n",
              "      <td>Bags</td>\n",
              "      <td>68674</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>12</th>\n",
              "      <td>Hats | Apparel | Google Merchandise Store</td>\n",
              "      <td>Hats</td>\n",
              "      <td>62171</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>13</th>\n",
              "      <td>Womens | Apparel | Google Merchandise Store</td>\n",
              "      <td>Womens</td>\n",
              "      <td>60667</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>14</th>\n",
              "      <td>Campus Collection | Google Merchandise Store</td>\n",
              "      <td>CampusCollection</td>\n",
              "      <td>56129</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>15</th>\n",
              "      <td>Page Unavailable</td>\n",
              "      <td>PageUnavailable</td>\n",
              "      <td>56030</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>16</th>\n",
              "      <td>Eco-Friendly | Google Merchandise Store</td>\n",
              "      <td>EcoFriendly</td>\n",
              "      <td>55492</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>17</th>\n",
              "      <td>Payment Method</td>\n",
              "      <td>PaymentMethod</td>\n",
              "      <td>49803</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>\n",
              "      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-c870c7ae-9699-445a-9e62-39e14f80f51c')\"\n",
              "              title=\"Convert this dataframe to an interactive table.\"\n",
              "              style=\"display:none;\">\n",
              "        \n",
              "  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n",
              "       width=\"24px\">\n",
              "    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n",
              "    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n",
              "  </svg>\n",
              "      </button>\n",
              "      \n",
              "  <style>\n",
              "    .colab-df-container {\n",
              "      display:flex;\n",
              "      flex-wrap:wrap;\n",
              "      gap: 12px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert {\n",
              "      background-color: #E8F0FE;\n",
              "      border: none;\n",
              "      border-radius: 50%;\n",
              "      cursor: pointer;\n",
              "      display: none;\n",
              "      fill: #1967D2;\n",
              "      height: 32px;\n",
              "      padding: 0 0 0 0;\n",
              "      width: 32px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert:hover {\n",
              "      background-color: #E2EBFA;\n",
              "      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n",
              "      fill: #174EA6;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert {\n",
              "      background-color: #3B4455;\n",
              "      fill: #D2E3FC;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert:hover {\n",
              "      background-color: #434B5C;\n",
              "      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n",
              "      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n",
              "      fill: #FFFFFF;\n",
              "    }\n",
              "  </style>\n",
              "\n",
              "      <script>\n",
              "        const buttonEl =\n",
              "          document.querySelector('#df-c870c7ae-9699-445a-9e62-39e14f80f51c button.colab-df-convert');\n",
              "        buttonEl.style.display =\n",
              "          google.colab.kernel.accessAllowed ? 'block' : 'none';\n",
              "\n",
              "        async function convertToInteractive(key) {\n",
              "          const element = document.querySelector('#df-c870c7ae-9699-445a-9e62-39e14f80f51c');\n",
              "          const dataTable =\n",
              "            await google.colab.kernel.invokeFunction('convertToInteractive',\n",
              "                                                     [key], {});\n",
              "          if (!dataTable) return;\n",
              "\n",
              "          const docLinkHtml = 'Like what you see? Visit the ' +\n",
              "            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n",
              "            + ' to learn more about interactive tables.';\n",
              "          element.innerHTML = '';\n",
              "          dataTable['output_type'] = 'display_data';\n",
              "          await google.colab.output.renderOutput(dataTable, element);\n",
              "          const docLink = document.createElement('div');\n",
              "          docLink.innerHTML = docLinkHtml;\n",
              "          element.appendChild(docLink);\n",
              "        }\n",
              "      </script>\n",
              "    </div>\n",
              "  </div>\n",
              "  "
            ]
          },
          "metadata": {},
          "execution_count": 9
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "In the Google Merchandise Store, these are the top most visited pages cumulatively by all users. This table might look very different for your dataset and store.\n",
        "However, since we are using the general function, it won't matter as our goal is to identify the topmost pages. This query and function will give you the top-visited pages as long as you have page_title in your export schema."
      ],
      "metadata": {
        "id": "bE8nte7dZCHt"
      },
      "id": "bE8nte7dZCHt"
    },
    {
      "cell_type": "markdown",
      "source": [
        "The goal is to create a dynamic query such that it can take top pages visited across all users and then count the number of times the user has seen that page to generate user interest. However, the page_title text is sometimes very descriptive and may require some cleaning before being used for the dynamic query."
      ],
      "metadata": {
        "id": "w9fbw_e3bXeL"
      },
      "id": "w9fbw_e3bXeL"
    },
    {
      "cell_type": "code",
      "source": [
        "def get_query_string(page_title_keys,page_title):\n",
        "\n",
        "    \"\"\"\n",
        "    The function accepts:\n",
        "    page_title_keys: All the keys from page_title (extracted from the previous function) that are used as column names and variable names.\n",
        "    page_title: page_title dataframe that contains all columns\n",
        "\n",
        "    This function achieves two things:\n",
        "    1) Dynamically generates the WHEN matching query\n",
        "    2) Dynamically generates the SELECT query\n",
        "\n",
        "    case_when_string_list: Empty list that will store CASE WHEN dynamic SQL query string based on page_title keys (column names)\n",
        "    select_key_string_list: Empty list that will store SELECT dynamic SQL query string based on page_title keys (column names)\n",
        "    \"\"\"\n",
        "    case_when_string_list = []\n",
        "    select_key_string_list = []\n",
        "    for eachkey in page_title_keys:\n",
        "      select_key_string = \\\n",
        "      f'IFNULL(item_page_view_table.pageVisit_count_sum_{eachkey},0) AS {eachkey}_visit_count,\\n'\n",
        "      select_key_string_list.append(select_key_string)\n",
        "\n",
        "    for index, row in page_title.iterrows():\n",
        "      case_when_string = \\\n",
        "          f\"\"\"WHEN ep.value.string_value LIKE \"{row['page_title']}\" THEN '{row['key']}'\\n\"\"\"\n",
        "      case_when_string_list.append(case_when_string)\n",
        "    return (' '.join(select_key_string_list),\n",
        "            ' '.join(case_when_string_list))"
      ],
      "metadata": {
        "id": "1olnmn5u-ffG"
      },
      "id": "1olnmn5u-ffG",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "(select_key_string, case_when_string) = \\\n",
        "    get_query_string(list(df['key']),df)"
      ],
      "metadata": {
        "id": "c-Ygz21SHCwb"
      },
      "id": "c-Ygz21SHCwb",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "print(select_key_string)\n",
        "#dynamic select query based on user selected pages"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "AZdJV8IZyvcd",
        "outputId": "745ac829-6b89-421c-952a-0f24e111c5d6"
      },
      "id": "AZdJV8IZyvcd",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "IFNULL(item_page_view_table.pageVisit_count_sum_Apparel,0) AS Apparel_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_ShoppingCart,0) AS ShoppingCart_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_MensUnisex,0) AS MensUnisex_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_YouTube,0) AS YouTube_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Sale,0) AS Sale_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_TheGoogleMerchandiseStoreLogIn,0) AS TheGoogleMerchandiseStoreLogIn_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_CheckoutYourInformation,0) AS CheckoutYourInformation_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Storesearchresults,0) AS Storesearchresults_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_GoogleDinoGameTee,0) AS GoogleDinoGameTee_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Drinkware,0) AS Drinkware_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_New,0) AS New_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Bags,0) AS Bags_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Hats,0) AS Hats_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Womens,0) AS Womens_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_CampusCollection,0) AS CampusCollection_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_PageUnavailable,0) AS PageUnavailable_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_EcoFriendly,0) AS EcoFriendly_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_PaymentMethod,0) AS PaymentMethod_visit_count,\n",
            "\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "print(case_when_string)\n",
        "#dynamic case when query based on user selected pages."
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "85nXoYT4yz2o",
        "outputId": "9158fcb1-3aaf-4b70-da96-90124cc881ca"
      },
      "id": "85nXoYT4yz2o",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "WHEN ep.value.string_value LIKE \"Apparel | Google Merchandise Store\" THEN 'Apparel'\n",
            " WHEN ep.value.string_value LIKE \"Shopping Cart\" THEN 'ShoppingCart'\n",
            " WHEN ep.value.string_value LIKE \"Men's / Unisex | Apparel | Google Merchandise Store\" THEN 'MensUnisex'\n",
            " WHEN ep.value.string_value LIKE \"YouTube | Shop by Brand | Google Merchandise Store\" THEN 'YouTube'\n",
            " WHEN ep.value.string_value LIKE \"Sale | Google Merchandise Store\" THEN 'Sale'\n",
            " WHEN ep.value.string_value LIKE \"The Google Merchandise Store - Log In\" THEN 'TheGoogleMerchandiseStoreLogIn'\n",
            " WHEN ep.value.string_value LIKE \"Checkout Your Information\" THEN 'CheckoutYourInformation'\n",
            " WHEN ep.value.string_value LIKE \"Store search results\" THEN 'Storesearchresults'\n",
            " WHEN ep.value.string_value LIKE \"Google Dino Game Tee\" THEN 'GoogleDinoGameTee'\n",
            " WHEN ep.value.string_value LIKE \"Drinkware | Lifestyle | Google Merchandise Store\" THEN 'Drinkware'\n",
            " WHEN ep.value.string_value LIKE \"New | Google Merchandise Store\" THEN 'New'\n",
            " WHEN ep.value.string_value LIKE \"Bags | Lifestyle | Google Merchandise Store\" THEN 'Bags'\n",
            " WHEN ep.value.string_value LIKE \"Hats | Apparel | Google Merchandise Store\" THEN 'Hats'\n",
            " WHEN ep.value.string_value LIKE \"Womens | Apparel | Google Merchandise Store\" THEN 'Womens'\n",
            " WHEN ep.value.string_value LIKE \"Campus Collection | Google Merchandise Store\" THEN 'CampusCollection'\n",
            " WHEN ep.value.string_value LIKE \"Page Unavailable\" THEN 'PageUnavailable'\n",
            " WHEN ep.value.string_value LIKE \"Eco-Friendly | Google Merchandise Store\" THEN 'EcoFriendly'\n",
            " WHEN ep.value.string_value LIKE \"Payment Method\" THEN 'PaymentMethod'\n",
            "\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "query = f\"\"\"\n",
        "CREATE OR REPLACE TABLE\n",
        "  ga4_ecomm_feature_set.ga4_features AS\n",
        "SELECT\n",
        "  item_page_view_table.user_pseudo_id,\n",
        "  {select_key_string}\n",
        "  total_event_table.total_event_count,\n",
        "  IFNULL(c.count_add_to_cart_count,\n",
        "    0) AS count_add_to_cart,\n",
        "  IFNULL(d.count_purchase_count,\n",
        "    0) AS count_purchase,\n",
        "  IFNULL(browse_feature.favorite_device_medium,\n",
        "    'NotAvailable') AS favorite_device_medium,\n",
        "  IFNULL(browse_feature.favorite_mobile_company_name,\n",
        "    'NotAvailable') AS favorite_mobile_company_name,\n",
        "  IFNULL(browse_feature.favorite_lang,\n",
        "    'NotAvailable') AS favorite_lang,\n",
        "  IFNULL(browse_feature.most_used_country,\n",
        "    'NotAvailable') AS most_used_country,\n",
        "  IFNULL(browse_feature.most_used_campaign,\n",
        "    'NotAvailable') AS most_used_campaign,\n",
        "  IFNULL(browse_feature.average_engagement_time_minute,\n",
        "    0) AS average_engagement_time_minute,\n",
        "FROM (\n",
        "  SELECT\n",
        "    *\n",
        "  FROM (\n",
        "    SELECT\n",
        "      user_pseudo_id,\n",
        "      CASE {case_when_string}\n",
        "      ELSE\n",
        "      \"Others\"\n",
        "    END\n",
        "      AS page_title,\n",
        "      COUNT(ep.value.string_value) AS pageVisit_count\n",
        "    FROM\n",
        "      `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events_*`,\n",
        "      UNNEST(event_params) AS ep\n",
        "    WHERE\n",
        "      ep.key = 'page_title'\n",
        "      AND ep.value.string_value IN {tuple(df['page_title'])}\n",
        "      AND event_date BETWEEN '{START_DATE}'\n",
        "      AND '{END_DATE}'\n",
        "      AND event_name = 'page_view'\n",
        "    GROUP BY\n",
        "      user_pseudo_id,\n",
        "      page_title ) PIVOT ( SUM(pageVisit_count) AS pageVisit_count_sum FOR page_title IN {tuple(df['key'])} ) ) item_page_view_table\n",
        "LEFT JOIN (\n",
        "  SELECT\n",
        "    user_pseudo_id,\n",
        "    COUNT(DISTINCT(event_date)) AS total_event_count,\n",
        "  FROM\n",
        "    `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events_*`\n",
        "  WHERE\n",
        "    event_date BETWEEN '{START_DATE}'\n",
        "    AND '{END_DATE}'\n",
        "  GROUP BY\n",
        "    user_pseudo_id) total_event_table\n",
        "ON\n",
        "  item_page_view_table.user_pseudo_id = total_event_table.user_pseudo_id\n",
        "LEFT JOIN (\n",
        "    SELECT\n",
        "        user_pseudo_id,\n",
        "        COUNT(*) AS count_add_to_cart_count\n",
        "      FROM\n",
        "        `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events_*`,\n",
        "        UNNEST (event_params) AS ep\n",
        "      WHERE\n",
        "        event_name = 'add_to_cart'\n",
        "        AND\n",
        "        event_date BETWEEN '{START_DATE}'\n",
        "    AND '{END_DATE}'\n",
        "      GROUP BY\n",
        "        user_pseudo_id) c\n",
        "    ON\n",
        "      item_page_view_table.user_pseudo_id = c.user_pseudo_id\n",
        "LEFT JOIN (\n",
        "    SELECT\n",
        "        user_pseudo_id,\n",
        "        COUNT(*) AS count_purchase_count\n",
        "      FROM\n",
        "        `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events_*`,\n",
        "        UNNEST (event_params) AS ep\n",
        "      WHERE\n",
        "        event_name = 'purchase'\n",
        "        AND\n",
        "        event_date BETWEEN '{START_DATE}'\n",
        "    AND '{END_DATE}'\n",
        "      GROUP BY\n",
        "        user_pseudo_id) d\n",
        "    ON\n",
        "      item_page_view_table.user_pseudo_id = d.user_pseudo_id\n",
        "LEFT JOIN (\n",
        "  SELECT\n",
        "    user_pseudo_id,\n",
        "    MAX(device.category) AS favorite_device_medium,\n",
        "    MAX(device.mobile_brand_name) AS favorite_mobile_company_name,\n",
        "    MAX(device.LANGUAGE) AS favorite_lang,\n",
        "    MAX(geo.country) AS most_used_country,\n",
        "    MAX(\n",
        "    IF\n",
        "      (events.key = \"campaign\",\n",
        "        events.value.string_value,\n",
        "        NULL)) AS most_used_campaign,\n",
        "    ROUND(AVG(\n",
        "      IF\n",
        "        (events.key = \"engagement_time_msec\",\n",
        "          events.value.int_value,\n",
        "          NULL))/60000,2) AS average_engagement_time_minute,\n",
        "  FROM\n",
        "    `{PROJECT_ID_DATA}.{DATASET_ID_DATA}.events_*`,\n",
        "    UNNEST(event_params) AS events,\n",
        "    UNNEST(items) AS item\n",
        "  WHERE\n",
        "    event_date BETWEEN '{START_DATE}'\n",
        "    AND '{END_DATE}'\n",
        "  GROUP BY\n",
        "    user_pseudo_id ) browse_feature\n",
        "ON\n",
        "  item_page_view_table.user_pseudo_id = browse_feature.user_pseudo_id\n",
        "WHERE\n",
        "  item_page_view_table.user_pseudo_id IS NOT NULL\n",
        "\"\"\"\n",
        "query_job = client.query(query)\n",
        "# print(query)"
      ],
      "metadata": {
        "id": "nnfl8VImHHm0",
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "outputId": "2177b50c-beb0-4864-9a8d-33e8d5f9ad5d"
      },
      "id": "nnfl8VImHHm0",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "\n",
            "CREATE OR REPLACE TABLE\n",
            "  ga4_ecomm_feature_set.ga4_features AS\n",
            "SELECT\n",
            "  item_page_view_table.user_pseudo_id,\n",
            "  IFNULL(item_page_view_table.pageVisit_count_sum_Apparel,0) AS Apparel_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_ShoppingCart,0) AS ShoppingCart_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_MensUnisex,0) AS MensUnisex_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_YouTube,0) AS YouTube_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Sale,0) AS Sale_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_TheGoogleMerchandiseStoreLogIn,0) AS TheGoogleMerchandiseStoreLogIn_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_CheckoutYourInformation,0) AS CheckoutYourInformation_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Storesearchresults,0) AS Storesearchresults_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_GoogleDinoGameTee,0) AS GoogleDinoGameTee_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Drinkware,0) AS Drinkware_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_New,0) AS New_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Bags,0) AS Bags_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Hats,0) AS Hats_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_Womens,0) AS Womens_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_CampusCollection,0) AS CampusCollection_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_PageUnavailable,0) AS PageUnavailable_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_EcoFriendly,0) AS EcoFriendly_visit_count,\n",
            " IFNULL(item_page_view_table.pageVisit_count_sum_PaymentMethod,0) AS PaymentMethod_visit_count,\n",
            " \n",
            "  total_event_table.total_event_count,\n",
            "  IFNULL(c.count_add_to_cart_count,\n",
            "    0) AS count_add_to_cart,\n",
            "  IFNULL(d.count_purchase_count,\n",
            "    0) AS count_purchase,\n",
            "  IFNULL(browse_feature.favorite_device_medium,\n",
            "    'NotAvailable') AS favorite_device_medium,\n",
            "  IFNULL(browse_feature.favorite_mobile_company_name,\n",
            "    'NotAvailable') AS favorite_mobile_company_name,\n",
            "  IFNULL(browse_feature.favorite_lang,\n",
            "    'NotAvailable') AS favorite_lang,\n",
            "  IFNULL(browse_feature.most_used_country,\n",
            "    'NotAvailable') AS most_used_country,\n",
            "  IFNULL(browse_feature.most_used_campaign,\n",
            "    'NotAvailable') AS most_used_campaign,\n",
            "  IFNULL(browse_feature.average_engagement_time_minute,\n",
            "    0) AS average_engagement_time_minute,\n",
            "FROM (\n",
            "  SELECT\n",
            "    *\n",
            "  FROM (\n",
            "    SELECT\n",
            "      user_pseudo_id,\n",
            "      CASE WHEN ep.value.string_value LIKE \"Apparel | Google Merchandise Store\" THEN 'Apparel'\n",
            " WHEN ep.value.string_value LIKE \"Shopping Cart\" THEN 'ShoppingCart'\n",
            " WHEN ep.value.string_value LIKE \"Men's / Unisex | Apparel | Google Merchandise Store\" THEN 'MensUnisex'\n",
            " WHEN ep.value.string_value LIKE \"YouTube | Shop by Brand | Google Merchandise Store\" THEN 'YouTube'\n",
            " WHEN ep.value.string_value LIKE \"Sale | Google Merchandise Store\" THEN 'Sale'\n",
            " WHEN ep.value.string_value LIKE \"The Google Merchandise Store - Log In\" THEN 'TheGoogleMerchandiseStoreLogIn'\n",
            " WHEN ep.value.string_value LIKE \"Checkout Your Information\" THEN 'CheckoutYourInformation'\n",
            " WHEN ep.value.string_value LIKE \"Store search results\" THEN 'Storesearchresults'\n",
            " WHEN ep.value.string_value LIKE \"Google Dino Game Tee\" THEN 'GoogleDinoGameTee'\n",
            " WHEN ep.value.string_value LIKE \"Drinkware | Lifestyle | Google Merchandise Store\" THEN 'Drinkware'\n",
            " WHEN ep.value.string_value LIKE \"New | Google Merchandise Store\" THEN 'New'\n",
            " WHEN ep.value.string_value LIKE \"Bags | Lifestyle | Google Merchandise Store\" THEN 'Bags'\n",
            " WHEN ep.value.string_value LIKE \"Hats | Apparel | Google Merchandise Store\" THEN 'Hats'\n",
            " WHEN ep.value.string_value LIKE \"Womens | Apparel | Google Merchandise Store\" THEN 'Womens'\n",
            " WHEN ep.value.string_value LIKE \"Campus Collection | Google Merchandise Store\" THEN 'CampusCollection'\n",
            " WHEN ep.value.string_value LIKE \"Page Unavailable\" THEN 'PageUnavailable'\n",
            " WHEN ep.value.string_value LIKE \"Eco-Friendly | Google Merchandise Store\" THEN 'EcoFriendly'\n",
            " WHEN ep.value.string_value LIKE \"Payment Method\" THEN 'PaymentMethod'\n",
            "\n",
            "      ELSE\n",
            "      \"Others\"\n",
            "    END\n",
            "      AS page_title,\n",
            "      COUNT(ep.value.string_value) AS pageVisit_count\n",
            "    FROM\n",
            "      `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`,\n",
            "      UNNEST(event_params) AS ep\n",
            "    WHERE\n",
            "      ep.key = 'page_title'\n",
            "      AND ep.value.string_value IN ('Apparel | Google Merchandise Store', 'Shopping Cart', \"Men's / Unisex | Apparel | Google Merchandise Store\", 'YouTube | Shop by Brand | Google Merchandise Store', 'Sale | Google Merchandise Store', 'The Google Merchandise Store - Log In', 'Checkout Your Information', 'Store search results', 'Google Dino Game Tee', 'Drinkware | Lifestyle | Google Merchandise Store', 'New | Google Merchandise Store', 'Bags | Lifestyle | Google Merchandise Store', 'Hats | Apparel | Google Merchandise Store', 'Womens | Apparel | Google Merchandise Store', 'Campus Collection | Google Merchandise Store', 'Page Unavailable', 'Eco-Friendly | Google Merchandise Store', 'Payment Method')\n",
            "      AND event_date BETWEEN '20201101'\n",
            "      AND '20210131'\n",
            "      AND event_name = 'page_view'\n",
            "    GROUP BY\n",
            "      user_pseudo_id,\n",
            "      page_title ) PIVOT ( SUM(pageVisit_count) AS pageVisit_count_sum FOR page_title IN ('Apparel', 'ShoppingCart', 'MensUnisex', 'YouTube', 'Sale', 'TheGoogleMerchandiseStoreLogIn', 'CheckoutYourInformation', 'Storesearchresults', 'GoogleDinoGameTee', 'Drinkware', 'New', 'Bags', 'Hats', 'Womens', 'CampusCollection', 'PageUnavailable', 'EcoFriendly', 'PaymentMethod') ) ) item_page_view_table\n",
            "LEFT JOIN (\n",
            "  SELECT\n",
            "    user_pseudo_id,\n",
            "    COUNT(DISTINCT(event_date)) AS total_event_count,\n",
            "  FROM\n",
            "    `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`\n",
            "  WHERE\n",
            "    event_date BETWEEN '20201101'\n",
            "    AND '20210131'\n",
            "  GROUP BY\n",
            "    user_pseudo_id) total_event_table\n",
            "ON\n",
            "  item_page_view_table.user_pseudo_id = total_event_table.user_pseudo_id \n",
            "LEFT JOIN (\n",
            "    SELECT\n",
            "        user_pseudo_id,\n",
            "        COUNT(*) AS count_add_to_cart_count\n",
            "      FROM\n",
            "        `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`,\n",
            "        UNNEST (event_params) AS ep\n",
            "      WHERE\n",
            "        event_name = 'add_to_cart'\n",
            "        AND\n",
            "        event_date BETWEEN '20201101'\n",
            "    AND '20210131'\n",
            "      GROUP BY\n",
            "        user_pseudo_id) c\n",
            "    ON\n",
            "      item_page_view_table.user_pseudo_id = c.user_pseudo_id\n",
            "LEFT JOIN (\n",
            "    SELECT\n",
            "        user_pseudo_id,\n",
            "        COUNT(*) AS count_purchase_count\n",
            "      FROM\n",
            "        `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`,\n",
            "        UNNEST (event_params) AS ep\n",
            "      WHERE\n",
            "        event_name = 'purchase'\n",
            "        AND\n",
            "        event_date BETWEEN '20201101'\n",
            "    AND '20210131'\n",
            "      GROUP BY\n",
            "        user_pseudo_id) d\n",
            "    ON\n",
            "      item_page_view_table.user_pseudo_id = d.user_pseudo_id\n",
            "LEFT JOIN (\n",
            "  SELECT\n",
            "    user_pseudo_id,\n",
            "    MAX(device.category) AS favorite_device_medium,\n",
            "    MAX(device.mobile_brand_name) AS favorite_mobile_company_name,\n",
            "    MAX(device.LANGUAGE) AS favorite_lang,\n",
            "    MAX(geo.country) AS most_used_country,\n",
            "    MAX(\n",
            "    IF\n",
            "      (events.key = \"campaign\",\n",
            "        events.value.string_value,\n",
            "        NULL)) AS most_used_campaign,\n",
            "    ROUND(AVG(\n",
            "      IF\n",
            "        (events.key = \"engagement_time_msec\",\n",
            "          events.value.int_value,\n",
            "          NULL))/60000,2) AS average_engagement_time_minute,\n",
            "  FROM\n",
            "    `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`,\n",
            "    UNNEST(event_params) AS events,\n",
            "    UNNEST(items) AS item\n",
            "  WHERE\n",
            "    event_date BETWEEN '20201101'\n",
            "    AND '20210131'\n",
            "  GROUP BY\n",
            "    user_pseudo_id ) browse_feature\n",
            "ON\n",
            "  item_page_view_table.user_pseudo_id = browse_feature.user_pseudo_id\n",
            "WHERE\n",
            "  item_page_view_table.user_pseudo_id IS NOT NULL\n",
            "\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "query = \"\"\"\n",
        "\n",
        "SELECT\n",
        "  *\n",
        "FROM\n",
        "  `ga4_ecomm_feature_set.ga4_features`\n",
        "LIMIT\n",
        "5\n",
        "\"\"\"\n",
        "\n",
        "query_job = client.query(query)\n",
        "result_df = query_job.to_dataframe()\n",
        "result_df.head()"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 270
        },
        "id": "EsYLSb48KIHP",
        "outputId": "58cbadd6-931e-4ae5-a847-2a6aef49a85c"
      },
      "id": "EsYLSb48KIHP",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "        user_pseudo_id  Apparel_visit_count  ShoppingCart_visit_count  \\\n",
              "0   7127030.2823157340                    0                         1   \n",
              "1   2587391.4095259630                    0                         0   \n",
              "2   2664459.3880988628                    0                        13   \n",
              "3  34044207.6843308841                    0                        15   \n",
              "4   1996659.1269737110                    0                         0   \n",
              "\n",
              "   MensUnisex_visit_count  YouTube_visit_count  Sale_visit_count  \\\n",
              "0                       0                    0                 0   \n",
              "1                       0                    0                 0   \n",
              "2                       1                    0                 0   \n",
              "3                      14                    0                 3   \n",
              "4                       0                    0                 0   \n",
              "\n",
              "   TheGoogleMerchandiseStoreLogIn_visit_count  \\\n",
              "0                                           1   \n",
              "1                                           0   \n",
              "2                                           3   \n",
              "3                                           4   \n",
              "4                                           0   \n",
              "\n",
              "   CheckoutYourInformation_visit_count  Storesearchresults_visit_count  \\\n",
              "0                                    1                               0   \n",
              "1                                    0                               0   \n",
              "2                                    3                               1   \n",
              "3                                    1                               5   \n",
              "4                                    0                               0   \n",
              "\n",
              "   GoogleDinoGameTee_visit_count  Drinkware_visit_count  New_visit_count  \\\n",
              "0                              0                      2                0   \n",
              "1                              0                      1                1   \n",
              "2                              0                      0                1   \n",
              "3                              0                      3                1   \n",
              "4                              0                      1                0   \n",
              "\n",
              "   Bags_visit_count  Hats_visit_count  Womens_visit_count  \\\n",
              "0                 1                 0                   0   \n",
              "1                 0                 0                   0   \n",
              "2                 0                 0                   1   \n",
              "3                 3                 1                   2   \n",
              "4                 0                 0                   0   \n",
              "\n",
              "   CampusCollection_visit_count  PageUnavailable_visit_count  \\\n",
              "0                             0                            0   \n",
              "1                             1                            0   \n",
              "2                             0                            0   \n",
              "3                             3                            0   \n",
              "4                             0                            0   \n",
              "\n",
              "   EcoFriendly_visit_count  PaymentMethod_visit_count  total_event_count  \\\n",
              "0                        0                          1                  2   \n",
              "1                        1                          0                  1   \n",
              "2                        1                          3                  4   \n",
              "3                        3                          2                  3   \n",
              "4                        0                          0                  1   \n",
              "\n",
              "   count_add_to_cart  count_purchase favorite_device_medium  \\\n",
              "0                  9              18                desktop   \n",
              "1                  0               0                 tablet   \n",
              "2                  0               0                 mobile   \n",
              "3                  0              15                 mobile   \n",
              "4                  0               0                desktop   \n",
              "\n",
              "  favorite_mobile_company_name favorite_lang most_used_country  \\\n",
              "0                        Apple  NotAvailable           Bahamas   \n",
              "1                        Apple         en-us             Italy   \n",
              "2                        Apple         en-us            Turkey   \n",
              "3                        Apple  NotAvailable     United States   \n",
              "4                        Apple         en-gb     United States   \n",
              "\n",
              "  most_used_campaign  average_engagement_time_minute  \n",
              "0         (referral)                            0.29  \n",
              "1         (referral)                            0.09  \n",
              "2          (organic)                            0.11  \n",
              "3         (referral)                            0.32  \n",
              "4           (direct)                            0.00  "
            ],
            "text/html": [
              "\n",
              "  <div id=\"df-4495af12-b3ac-4f0d-9142-4163973a18ec\">\n",
              "    <div class=\"colab-df-container\">\n",
              "      <div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>user_pseudo_id</th>\n",
              "      <th>Apparel_visit_count</th>\n",
              "      <th>ShoppingCart_visit_count</th>\n",
              "      <th>MensUnisex_visit_count</th>\n",
              "      <th>YouTube_visit_count</th>\n",
              "      <th>Sale_visit_count</th>\n",
              "      <th>TheGoogleMerchandiseStoreLogIn_visit_count</th>\n",
              "      <th>CheckoutYourInformation_visit_count</th>\n",
              "      <th>Storesearchresults_visit_count</th>\n",
              "      <th>GoogleDinoGameTee_visit_count</th>\n",
              "      <th>Drinkware_visit_count</th>\n",
              "      <th>New_visit_count</th>\n",
              "      <th>Bags_visit_count</th>\n",
              "      <th>Hats_visit_count</th>\n",
              "      <th>Womens_visit_count</th>\n",
              "      <th>CampusCollection_visit_count</th>\n",
              "      <th>PageUnavailable_visit_count</th>\n",
              "      <th>EcoFriendly_visit_count</th>\n",
              "      <th>PaymentMethod_visit_count</th>\n",
              "      <th>total_event_count</th>\n",
              "      <th>count_add_to_cart</th>\n",
              "      <th>count_purchase</th>\n",
              "      <th>favorite_device_medium</th>\n",
              "      <th>favorite_mobile_company_name</th>\n",
              "      <th>favorite_lang</th>\n",
              "      <th>most_used_country</th>\n",
              "      <th>most_used_campaign</th>\n",
              "      <th>average_engagement_time_minute</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>7127030.2823157340</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>2</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>2</td>\n",
              "      <td>9</td>\n",
              "      <td>18</td>\n",
              "      <td>desktop</td>\n",
              "      <td>Apple</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>Bahamas</td>\n",
              "      <td>(referral)</td>\n",
              "      <td>0.29</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>1</th>\n",
              "      <td>2587391.4095259630</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>tablet</td>\n",
              "      <td>Apple</td>\n",
              "      <td>en-us</td>\n",
              "      <td>Italy</td>\n",
              "      <td>(referral)</td>\n",
              "      <td>0.09</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>2</th>\n",
              "      <td>2664459.3880988628</td>\n",
              "      <td>0</td>\n",
              "      <td>13</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>3</td>\n",
              "      <td>3</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>3</td>\n",
              "      <td>4</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>mobile</td>\n",
              "      <td>Apple</td>\n",
              "      <td>en-us</td>\n",
              "      <td>Turkey</td>\n",
              "      <td>(organic)</td>\n",
              "      <td>0.11</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>3</th>\n",
              "      <td>34044207.6843308841</td>\n",
              "      <td>0</td>\n",
              "      <td>15</td>\n",
              "      <td>14</td>\n",
              "      <td>0</td>\n",
              "      <td>3</td>\n",
              "      <td>4</td>\n",
              "      <td>1</td>\n",
              "      <td>5</td>\n",
              "      <td>0</td>\n",
              "      <td>3</td>\n",
              "      <td>1</td>\n",
              "      <td>3</td>\n",
              "      <td>1</td>\n",
              "      <td>2</td>\n",
              "      <td>3</td>\n",
              "      <td>0</td>\n",
              "      <td>3</td>\n",
              "      <td>2</td>\n",
              "      <td>3</td>\n",
              "      <td>0</td>\n",
              "      <td>15</td>\n",
              "      <td>mobile</td>\n",
              "      <td>Apple</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>United States</td>\n",
              "      <td>(referral)</td>\n",
              "      <td>0.32</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>4</th>\n",
              "      <td>1996659.1269737110</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>desktop</td>\n",
              "      <td>Apple</td>\n",
              "      <td>en-gb</td>\n",
              "      <td>United States</td>\n",
              "      <td>(direct)</td>\n",
              "      <td>0.00</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>\n",
              "      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-4495af12-b3ac-4f0d-9142-4163973a18ec')\"\n",
              "              title=\"Convert this dataframe to an interactive table.\"\n",
              "              style=\"display:none;\">\n",
              "        \n",
              "  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n",
              "       width=\"24px\">\n",
              "    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n",
              "    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n",
              "  </svg>\n",
              "      </button>\n",
              "      \n",
              "  <style>\n",
              "    .colab-df-container {\n",
              "      display:flex;\n",
              "      flex-wrap:wrap;\n",
              "      gap: 12px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert {\n",
              "      background-color: #E8F0FE;\n",
              "      border: none;\n",
              "      border-radius: 50%;\n",
              "      cursor: pointer;\n",
              "      display: none;\n",
              "      fill: #1967D2;\n",
              "      height: 32px;\n",
              "      padding: 0 0 0 0;\n",
              "      width: 32px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert:hover {\n",
              "      background-color: #E2EBFA;\n",
              "      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n",
              "      fill: #174EA6;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert {\n",
              "      background-color: #3B4455;\n",
              "      fill: #D2E3FC;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert:hover {\n",
              "      background-color: #434B5C;\n",
              "      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n",
              "      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n",
              "      fill: #FFFFFF;\n",
              "    }\n",
              "  </style>\n",
              "\n",
              "      <script>\n",
              "        const buttonEl =\n",
              "          document.querySelector('#df-4495af12-b3ac-4f0d-9142-4163973a18ec button.colab-df-convert');\n",
              "        buttonEl.style.display =\n",
              "          google.colab.kernel.accessAllowed ? 'block' : 'none';\n",
              "\n",
              "        async function convertToInteractive(key) {\n",
              "          const element = document.querySelector('#df-4495af12-b3ac-4f0d-9142-4163973a18ec');\n",
              "          const dataTable =\n",
              "            await google.colab.kernel.invokeFunction('convertToInteractive',\n",
              "                                                     [key], {});\n",
              "          if (!dataTable) return;\n",
              "\n",
              "          const docLinkHtml = 'Like what you see? Visit the ' +\n",
              "            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n",
              "            + ' to learn more about interactive tables.';\n",
              "          element.innerHTML = '';\n",
              "          dataTable['output_type'] = 'display_data';\n",
              "          await google.colab.output.renderOutput(dataTable, element);\n",
              "          const docLink = document.createElement('div');\n",
              "          docLink.innerHTML = docLinkHtml;\n",
              "          element.appendChild(docLink);\n",
              "        }\n",
              "      </script>\n",
              "    </div>\n",
              "  </div>\n",
              "  "
            ]
          },
          "metadata": {},
          "execution_count": 25
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "## BQML Modeling"
      ],
      "metadata": {
        "id": "I4i8g9LDc5RA"
      },
      "id": "I4i8g9LDc5RA"
    },
    {
      "cell_type": "markdown",
      "source": [
        "Now that you have the feature data stored in 'ga4_features' table, you can start the BQML K-means Modeling.\n",
        "\n",
        "You should define dataset_id and feature_table, which can be used while building Python code for modeling."
      ],
      "metadata": {
        "id": "Ma6oHvBxjkXc"
      },
      "id": "Ma6oHvBxjkXc"
    },
    {
      "cell_type": "code",
      "source": [
        "dataset_id = \"ga4_ecomm_feature_set\"\n",
        "feature_table=\"ga4_features\" #table name"
      ],
      "metadata": {
        "id": "EXcfeCpSAaOL"
      },
      "id": "EXcfeCpSAaOL",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "Before starting the model, there are some important points to remember:\n",
        "\n",
        "1) Remove user_pseudo_id, as it is not a feature but an identifier for the user. In addition, this column has high cardinality, meaning a higher amount of unique values, and hence should not be taken during model building. Make sure to remove any such columns (typical examples like - serial. nos, some IDs). Otherwise, model building times will be massive and might not yield good results.\n",
        "\n",
        "2) The dataset contains both categorical and numerical columns, and BQML will take care of normalizations and categorical encoding automcatically.\n",
        "\n",
        "\n",
        "\n",
        "---\n",
        "\n",
        "\n",
        "The most important part of K-means clustering is to decide the number of clusters to be used during model training. The parameter `num_cluster` has to be determined by user. The value chooses how many segments you want to do in your data. Depending on business requirements, it can range from values as low as 3 and can go up to 100 or more.\n",
        "\n",
        "Some basic examples like hand-written digits clustering will have a straightforward `num_clusters` value as 10, since it's known beforehand.\n",
        "\n",
        "Similarly, maybe your marketing or business teams would like to run some campaigns against three segments of users. Here, you can also observe that `num_clusters` value is know (k=3).\n",
        "\n",
        "However, it is not always this straightforward; hence, identifying the correct value for such situations is crucial.\n",
        "\n",
        "For such situations, we can use the [Hyper Parameter Tuning](https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-hyperparameter-tuning) feature of BQML to identify the best value of `num_clusters` based on the [Davis-Bouldin](https://en.wikipedia.org/wiki/Davies%E2%80%93Bouldin_index) score and elbow method.\n"
      ],
      "metadata": {
        "id": "nWHRx9Nzi6kw"
      },
      "id": "nWHRx9Nzi6kw"
    },
    {
      "cell_type": "markdown",
      "source": [
        "\n",
        "\n",
        "---\n",
        "\n",
        "For this experiment, it is important to set a few parameters:\n",
        "- min_cluster_num - minimum number for clusters\n",
        "\n",
        "- max_cluster_num - maximum number for clusters\n",
        "\n",
        "- num_trails - The maximum number of submodels to train. The tuning will stop when num_trials submodels are trained or when the hyperparameter search space is exhausted. The maximum value is 100. Since we have fourteen values to explore, we will set this as 14.\n",
        "\n",
        "- max_parallel_trails - The maximum number of trials to run at the same time. The default value is one, and the maximum value is 5. We will set this at five the max since there are a lot of parameters to be explored, and hence parallelizing them would make the process faster.\n",
        "\n",
        "\n",
        "This query will take some time to run, roughly around ~8 minutes for this data. It may vary for your data."
      ],
      "metadata": {
        "id": "ICB3F0Cfk7Lq"
      },
      "id": "ICB3F0Cfk7Lq"
    },
    {
      "cell_type": "code",
      "source": [
        "min_cluster_num = 4\n",
        "max_cluster_num = 20\n",
        "model_name = \"model_hptune\"\n",
        "\n",
        "model_hp_tunning_query = f\"\"\"\n",
        "CREATE MODEL\n",
        "  `ga4_ecomm_feature_set.{model_name}`\n",
        "OPTIONS\n",
        "  ( MODEL_TYPE='KMEANS',\n",
        "    NUM_CLUSTERS = hparam_range({min_cluster_num},{max_cluster_num}),\n",
        "    num_trials=14,\n",
        "    max_parallel_trials=5\n",
        "    ) AS\n",
        "SELECT\n",
        "  * EXCEPT (user_pseudo_id)\n",
        "FROM `{PROJECT_ID}.{dataset_id}.{feature_table}`\n",
        "\n",
        "\"\"\"\n",
        "query_job = client.query(model_hp_tunning_query)"
      ],
      "metadata": {
        "id": "ZDybb73d3Ht5"
      },
      "id": "ZDybb73d3Ht5",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "Once the experiment finishes (around ~ 8 minutes), you can extract the Davies Bouldin score using ML.TRAIL_INFO method. These values will be required to identify the best deal.\n",
        "Ideally, the lowest value of the score gives the best value of `num_clusters`"
      ],
      "metadata": {
        "id": "EcWluRULlzyO"
      },
      "id": "EcWluRULlzyO"
    },
    {
      "cell_type": "code",
      "source": [
        "ml_evaluate_query = f\"\"\"\n",
        "WITH trail_data as (\n",
        "select *\n",
        "    FROM ML.TRIAL_INFO(MODEL ga4_ecomm_feature_set.{model_name})\n",
        ")\n",
        "select\n",
        "trial_id,\n",
        "hyperparameters.NUM_CLUSTERS,\n",
        "hparam_tuning_evaluation_metrics.davies_bouldin_index\n",
        "from\n",
        "trail_data\n",
        "\"\"\"\n",
        "query_job = client.query(ml_evaluate_query)\n",
        "ml_info_df = query_job.to_dataframe()\n",
        "ml_info_df.sort_values(by='NUM_CLUSTERS',inplace=True)\n",
        "ml_info_df"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 488
        },
        "id": "vsLmj--gDnZ9",
        "outputId": "157e2e48-1410-4dc9-ecce-6b4d14c67a89"
      },
      "id": "vsLmj--gDnZ9",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "    trial_id  NUM_CLUSTERS  davies_bouldin_index\n",
              "11        12             4              2.951032\n",
              "5          6             6              3.500190\n",
              "13        14             7              3.017528\n",
              "3          4             8              3.104007\n",
              "4          5             9              3.105792\n",
              "12        13            10              3.003407\n",
              "0          1            12              2.736230\n",
              "8          9            14              2.779411\n",
              "6          7            15              2.779358\n",
              "1          2            16              2.652802\n",
              "7          8            17              2.612906\n",
              "9         10            18              2.578516\n",
              "2          3            19              2.681777\n",
              "10        11            20              2.411998"
            ],
            "text/html": [
              "\n",
              "  <div id=\"df-402d3e8b-80ce-4ad0-8431-40c852465ec4\">\n",
              "    <div class=\"colab-df-container\">\n",
              "      <div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>trial_id</th>\n",
              "      <th>NUM_CLUSTERS</th>\n",
              "      <th>davies_bouldin_index</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>11</th>\n",
              "      <td>12</td>\n",
              "      <td>4</td>\n",
              "      <td>2.951032</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>5</th>\n",
              "      <td>6</td>\n",
              "      <td>6</td>\n",
              "      <td>3.500190</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>13</th>\n",
              "      <td>14</td>\n",
              "      <td>7</td>\n",
              "      <td>3.017528</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>3</th>\n",
              "      <td>4</td>\n",
              "      <td>8</td>\n",
              "      <td>3.104007</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>4</th>\n",
              "      <td>5</td>\n",
              "      <td>9</td>\n",
              "      <td>3.105792</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>12</th>\n",
              "      <td>13</td>\n",
              "      <td>10</td>\n",
              "      <td>3.003407</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>1</td>\n",
              "      <td>12</td>\n",
              "      <td>2.736230</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>8</th>\n",
              "      <td>9</td>\n",
              "      <td>14</td>\n",
              "      <td>2.779411</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>6</th>\n",
              "      <td>7</td>\n",
              "      <td>15</td>\n",
              "      <td>2.779358</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>1</th>\n",
              "      <td>2</td>\n",
              "      <td>16</td>\n",
              "      <td>2.652802</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>7</th>\n",
              "      <td>8</td>\n",
              "      <td>17</td>\n",
              "      <td>2.612906</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>9</th>\n",
              "      <td>10</td>\n",
              "      <td>18</td>\n",
              "      <td>2.578516</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>2</th>\n",
              "      <td>3</td>\n",
              "      <td>19</td>\n",
              "      <td>2.681777</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>10</th>\n",
              "      <td>11</td>\n",
              "      <td>20</td>\n",
              "      <td>2.411998</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>\n",
              "      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-402d3e8b-80ce-4ad0-8431-40c852465ec4')\"\n",
              "              title=\"Convert this dataframe to an interactive table.\"\n",
              "              style=\"display:none;\">\n",
              "        \n",
              "  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n",
              "       width=\"24px\">\n",
              "    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n",
              "    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n",
              "  </svg>\n",
              "      </button>\n",
              "      \n",
              "  <style>\n",
              "    .colab-df-container {\n",
              "      display:flex;\n",
              "      flex-wrap:wrap;\n",
              "      gap: 12px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert {\n",
              "      background-color: #E8F0FE;\n",
              "      border: none;\n",
              "      border-radius: 50%;\n",
              "      cursor: pointer;\n",
              "      display: none;\n",
              "      fill: #1967D2;\n",
              "      height: 32px;\n",
              "      padding: 0 0 0 0;\n",
              "      width: 32px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert:hover {\n",
              "      background-color: #E2EBFA;\n",
              "      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n",
              "      fill: #174EA6;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert {\n",
              "      background-color: #3B4455;\n",
              "      fill: #D2E3FC;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert:hover {\n",
              "      background-color: #434B5C;\n",
              "      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n",
              "      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n",
              "      fill: #FFFFFF;\n",
              "    }\n",
              "  </style>\n",
              "\n",
              "      <script>\n",
              "        const buttonEl =\n",
              "          document.querySelector('#df-402d3e8b-80ce-4ad0-8431-40c852465ec4 button.colab-df-convert');\n",
              "        buttonEl.style.display =\n",
              "          google.colab.kernel.accessAllowed ? 'block' : 'none';\n",
              "\n",
              "        async function convertToInteractive(key) {\n",
              "          const element = document.querySelector('#df-402d3e8b-80ce-4ad0-8431-40c852465ec4');\n",
              "          const dataTable =\n",
              "            await google.colab.kernel.invokeFunction('convertToInteractive',\n",
              "                                                     [key], {});\n",
              "          if (!dataTable) return;\n",
              "\n",
              "          const docLinkHtml = 'Like what you see? Visit the ' +\n",
              "            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n",
              "            + ' to learn more about interactive tables.';\n",
              "          element.innerHTML = '';\n",
              "          dataTable['output_type'] = 'display_data';\n",
              "          await google.colab.output.renderOutput(dataTable, element);\n",
              "          const docLink = document.createElement('div');\n",
              "          docLink.innerHTML = docLinkHtml;\n",
              "          element.appendChild(docLink);\n",
              "        }\n",
              "      </script>\n",
              "    </div>\n",
              "  </div>\n",
              "  "
            ]
          },
          "metadata": {},
          "execution_count": 26
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "However, the lowest value is not always the best indicator. The best value is the value after which the score stabilizes and doesn't drop or increase much. This can be easily figured out using an elbow curve by plotting a line graph of score vs. cluster values."
      ],
      "metadata": {
        "id": "puXGcHmEmXwW"
      },
      "id": "puXGcHmEmXwW"
    },
    {
      "cell_type": "markdown",
      "source": [
        "![](https://media.geeksforgeeks.org/wp-content/uploads/20190606105550/distortion1.png)"
      ],
      "metadata": {
        "id": "ORQPIygemhWZ"
      },
      "id": "ORQPIygemhWZ"
    },
    {
      "cell_type": "markdown",
      "source": [
        "In the above example, you can see that we are plotting distortions (David Bouldin Score) vs. K value (`num_clusters`). The goal is to find the \"elbow\" position of the graph and select that value for K.\n",
        "\n",
        "In the grapgh, you can see, K=3 or 4 seems to be an \"elbow,\" after which not much reduction in the score is observed, and it stabilizes. This is just an example; now you can draw a similar graph for the trials we have just performed."
      ],
      "metadata": {
        "id": "90WGL_JKnmbi"
      },
      "id": "90WGL_JKnmbi"
    },
    {
      "cell_type": "code",
      "source": [
        "fig = px.line(ml_info_df, x='NUM_CLUSTERS', y=['davies_bouldin_index'], markers=True)\n",
        "fig.show()"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 542
        },
        "id": "Xk5vKp6DD2Iv",
        "outputId": "48c8f9da-bbc4-49c0-cce2-94b39d80f730"
      },
      "id": "Xk5vKp6DD2Iv",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "display_data",
          "data": {
            "text/html": [
              "<html>\n",
              "<head><meta charset=\"utf-8\" /></head>\n",
              "<body>\n",
              "    <div>            <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG\"></script><script type=\"text/javascript\">if (window.MathJax) {MathJax.Hub.Config({SVG: {font: \"STIX-Web\"}});}</script>                <script type=\"text/javascript\">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>\n",
              "        <script src=\"https://cdn.plot.ly/plotly-2.8.3.min.js\"></script>                <div id=\"d1c0c551-2fe5-4ea0-bec3-505fd9850182\" class=\"plotly-graph-div\" style=\"height:525px; width:100%;\"></div>            <script type=\"text/javascript\">                                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById(\"d1c0c551-2fe5-4ea0-bec3-505fd9850182\")) {                    Plotly.newPlot(                        \"d1c0c551-2fe5-4ea0-bec3-505fd9850182\",                        [{\"hovertemplate\":\"variable=davies_bouldin_index<br>NUM_CLUSTERS=%{x}<br>value=%{y}<extra></extra>\",\"legendgroup\":\"davies_bouldin_index\",\"line\":{\"color\":\"#636efa\",\"dash\":\"solid\"},\"marker\":{\"symbol\":\"circle\"},\"mode\":\"lines+markers\",\"name\":\"davies_bouldin_index\",\"orientation\":\"v\",\"showlegend\":true,\"x\":[4,6,7,8,9,10,12,14,15,16,17,18,19,20],\"xaxis\":\"x\",\"y\":[2.951031800011079,3.50019039131578,3.0175276817123873,3.1040074575098897,3.10579206570142,3.0034072132776357,2.7362300454677735,2.779411362409025,2.779357744326472,2.6528015731293757,2.612906294610106,2.578516366034373,2.6817765001519076,2.4119984033690667],\"yaxis\":\"y\",\"type\":\"scatter\"}],                        {\"template\":{\"data\":{\"bar\":[{\"error_x\":{\"color\":\"#2a3f5f\"},\"error_y\":{\"color\":\"#2a3f5f\"},\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"bar\"}],\"barpolar\":[{\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"barpolar\"}],\"carpet\":[{\"aaxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"baxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"type\":\"carpet\"}],\"choropleth\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"choropleth\"}],\"contour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"contour\"}],\"contourcarpet\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"contourcarpet\"}],\"heatmap\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmap\"}],\"heatmapgl\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmapgl\"}],\"histogram\":[{\"marker\":{\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"histogram\"}],\"histogram2d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2d\"}],\"histogram2dcontour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2dcontour\"}],\"mesh3d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"mesh3d\"}],\"parcoords\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"parcoords\"}],\"pie\":[{\"automargin\":true,\"type\":\"pie\"}],\"scatter\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter\"}],\"scatter3d\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter3d\"}],\"scattercarpet\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattercarpet\"}],\"scattergeo\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergeo\"}],\"scattergl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergl\"}],\"scattermapbox\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattermapbox\"}],\"scatterpolar\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolar\"}],\"scatterpolargl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolargl\"}],\"scatterternary\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterternary\"}],\"surface\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"surface\"}],\"table\":[{\"cells\":{\"fill\":{\"color\":\"#EBF0F8\"},\"line\":{\"color\":\"white\"}},\"header\":{\"fill\":{\"color\":\"#C8D4E3\"},\"line\":{\"color\":\"white\"}},\"type\":\"table\"}]},\"layout\":{\"annotationdefaults\":{\"arrowcolor\":\"#2a3f5f\",\"arrowhead\":0,\"arrowwidth\":1},\"autotypenumbers\":\"strict\",\"coloraxis\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"colorscale\":{\"diverging\":[[0,\"#8e0152\"],[0.1,\"#c51b7d\"],[0.2,\"#de77ae\"],[0.3,\"#f1b6da\"],[0.4,\"#fde0ef\"],[0.5,\"#f7f7f7\"],[0.6,\"#e6f5d0\"],[0.7,\"#b8e186\"],[0.8,\"#7fbc41\"],[0.9,\"#4d9221\"],[1,\"#276419\"]],\"sequential\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"sequentialminus\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]},\"colorway\":[\"#636efa\",\"#EF553B\",\"#00cc96\",\"#ab63fa\",\"#FFA15A\",\"#19d3f3\",\"#FF6692\",\"#B6E880\",\"#FF97FF\",\"#FECB52\"],\"font\":{\"color\":\"#2a3f5f\"},\"geo\":{\"bgcolor\":\"white\",\"lakecolor\":\"white\",\"landcolor\":\"#E5ECF6\",\"showlakes\":true,\"showland\":true,\"subunitcolor\":\"white\"},\"hoverlabel\":{\"align\":\"left\"},\"hovermode\":\"closest\",\"mapbox\":{\"style\":\"light\"},\"paper_bgcolor\":\"white\",\"plot_bgcolor\":\"#E5ECF6\",\"polar\":{\"angularaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"radialaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"scene\":{\"xaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"yaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"zaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"}},\"shapedefaults\":{\"line\":{\"color\":\"#2a3f5f\"}},\"ternary\":{\"aaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"baxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"caxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"title\":{\"x\":0.05},\"xaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2},\"yaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2}}},\"xaxis\":{\"anchor\":\"y\",\"domain\":[0.0,1.0],\"title\":{\"text\":\"NUM_CLUSTERS\"}},\"yaxis\":{\"anchor\":\"x\",\"domain\":[0.0,1.0],\"title\":{\"text\":\"value\"}},\"legend\":{\"title\":{\"text\":\"variable\"},\"tracegroupgap\":0},\"margin\":{\"t\":60}},                        {\"responsive\": true}                    ).then(function(){\n",
              "                            \n",
              "var gd = document.getElementById('d1c0c551-2fe5-4ea0-bec3-505fd9850182');\n",
              "var x = new MutationObserver(function (mutations, observer) {{\n",
              "        var display = window.getComputedStyle(gd).display;\n",
              "        if (!display || display === 'none') {{\n",
              "            console.log([gd, 'removed!']);\n",
              "            Plotly.purge(gd);\n",
              "            observer.disconnect();\n",
              "        }}\n",
              "}});\n",
              "\n",
              "// Listen for the removal of the full notebook cells\n",
              "var notebookContainer = gd.closest('#notebook-container');\n",
              "if (notebookContainer) {{\n",
              "    x.observe(notebookContainer, {childList: true});\n",
              "}}\n",
              "\n",
              "// Listen for the clearing of the current output cell\n",
              "var outputEl = gd.closest('.output');\n",
              "if (outputEl) {{\n",
              "    x.observe(outputEl, {childList: true});\n",
              "}}\n",
              "\n",
              "                        })                };                            </script>        </div>\n",
              "</body>\n",
              "</html>"
            ]
          },
          "metadata": {}
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "In the graph, you don't get a proper elbow which can mean three things:\n",
        "\n",
        "1) You need more or better features to get better clusters, or\n",
        "\n",
        "2) You need to increase the `num_clusters` values in the trial.\n",
        "\n",
        "3) Data inherently doesn't have clusters and can not be segmented.\n",
        "\n",
        "You can try out the first two methods. However, be very careful in increasing the K value from 20 since it should have a strong business reason.\n",
        "\n",
        "Usually, the more the K value, the harder it is to make sense of the underlying features of clusters since there will be a lot of overlaps between values.\n",
        "\n",
        "In the graph, you can notice that the lowest value of David Bouldin's score is sitting at k=20. However, analyzing those many clusters would be challenging and overlapping, so for simplicity, we keep that at k=5 and assume that data has inherent clusters.\n",
        "\n",
        "As discussed earlier, this should be in tandem with your business objectives."
      ],
      "metadata": {
        "id": "aZuNUZtvp3fi"
      },
      "id": "aZuNUZtvp3fi"
    },
    {
      "cell_type": "code",
      "source": [
        "num_cluster = 5\n",
        "model_name = \"model_c5\"\n",
        "\n",
        "model_query = f\"\"\"\n",
        "CREATE OR REPLACE MODEL\n",
        "  `ga4_ecomm_feature_set.{model_name}`\n",
        "OPTIONS\n",
        "  ( MODEL_TYPE='KMEANS',\n",
        "    NUM_CLUSTERS = {num_cluster},\n",
        "    KMEANS_INIT_METHOD='KMEANS++'\n",
        "    ) AS\n",
        "SELECT\n",
        "  * EXCEPT (user_pseudo_id)\n",
        "FROM `{PROJECT_ID}.{dataset_id}.{feature_table}`\n",
        "\"\"\""
      ],
      "metadata": {
        "id": "wYb1WZdFJh_4"
      },
      "id": "wYb1WZdFJh_4",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "Once the training is complete, model objects are stored in BQ. You can look into the model evaluations through the BQ console that gives you cluster statistics.\n",
        "\n",
        "For example, the below images split the evaluations into numeric and categorical columns."
      ],
      "metadata": {
        "id": "R8r-_8E0ESDA"
      },
      "id": "R8r-_8E0ESDA"
    },
    {
      "cell_type": "markdown",
      "source": [
        "![](https://screenshot.googleplex.com/bkMq8m5bvDJVzQL.png)"
      ],
      "metadata": {
        "id": "98pxCQ4WKMz_"
      },
      "id": "98pxCQ4WKMz_"
    },
    {
      "cell_type": "markdown",
      "source": [
        "From the above table, you can observe the total count of records in each cluster and the centroid values (approximately average) of each numerical feature shown in the green bar with value. The values can give you a good insight into the character of each cluster, for example:\n",
        "\n",
        "- Cluster 1: Group of customers interested in Google Dino Game Tshirts and Youtube Merchandise. The marketing/sales team can use this information later to target these specific customers for any new game t-shirts or YouTube inventory.\n",
        "\n",
        "\n",
        "This, however, is just an evaluation of the training data. In actual scenarios, you will use this model to predict clusters on new data and then analyze each character in detail."
      ],
      "metadata": {
        "id": "yJO5I8G3EhP4"
      },
      "id": "yJO5I8G3EhP4"
    },
    {
      "cell_type": "markdown",
      "source": [
        "![](https://screenshot.googleplex.com/CFqy9ezurZPhP7o.png)\n",
        "\n",
        "![](https://screenshot.googleplex.com/BDVD8ASxAPkFCLL.png)"
      ],
      "metadata": {
        "id": "KLoBf50gK1AT"
      },
      "id": "KLoBf50gK1AT"
    },
    {
      "cell_type": "markdown",
      "source": [
        "Similarly above graph is a summary of statistics for categorical data. It presents the count distribution for each category for a given categorical column.\n",
        "\n",
        "In the example, you can see the graph for two columns, `favorite_mobile_company_name` and `most_used_campaign.`\n",
        "This can also help you understand some specific characters of each cluster.\n",
        "\n",
        "For example, in the second graph for `most_used_campign,` cluster 4 is a dominant \"referral\" customers.\n",
        "\n",
        "We will explore detailed exploration and predictions in the next section.\n",
        "\n",
        "The point to note here is that these are not the best clusters. You can already see overlapping values among features and uneven distributions of the count of users. You can again refer to the David Bouldin Score graph and notice that at k=5, we are not at the lowest loss (score).\n",
        "\n",
        "However, we chose to pick five to keep the analysis simple. In ideal scenarios, you would coordinate with the business and try to balance choosing k values with your score."
      ],
      "metadata": {
        "id": "GyT5XFRoHgxc"
      },
      "id": "GyT5XFRoHgxc"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Batch Prediction"
      ],
      "metadata": {
        "id": "nvoChYnuc_Af"
      },
      "id": "nvoChYnuc_Af"
    },
    {
      "cell_type": "markdown",
      "source": [
        "Now that the model is finalized, it's time to make batch predictions on new or incoming data. Since we don't have either, we will try to predict the same data (features) we used for modeling.\n",
        "\n",
        "The most crucial point is that the model prediction will happen on features and not on raw data in ideal scenarios. So, when new or incoming data comes, you need to run the feature engineering section to generate new features that your model can accept for batch predictions.\n",
        "\n",
        "For simplification and demonstration purposes, we use the same features for predictions used to train the model.\n",
        "\n",
        "You can use the `ML.PREDICT` method on the features. Here you don't need to exclude user_pseduo_id since that will be required to retarget customers based on their clusters ids.\n",
        "\n",
        "Another essential thing to do is to save the outputs in a BQ table so that it can be later used for any further integrations."
      ],
      "metadata": {
        "id": "1laQchX5LDkW"
      },
      "id": "1laQchX5LDkW"
    },
    {
      "cell_type": "code",
      "source": [
        "prediction_data_table_name = \"model_prediction_c5\"\n",
        "query = f\"\"\"\n",
        "CREATE OR REPLACE TABLE\n",
        "  ga4_ecomm_feature_set.{prediction_data_table_name} AS\n",
        "SELECT\n",
        "  * EXCEPT(trial_id,NEAREST_CENTROIDS_DISTANCE)\n",
        "FROM\n",
        "  ML.PREDICT(MODEL ga4_ecomm_feature_set.{model_name},\n",
        "    (\n",
        "    SELECT\n",
        "      *\n",
        "    FROM\n",
        "      `{PROJECT_ID}.{dataset_id}.{feature_table}`))\n",
        "\"\"\"\n",
        "query_job = client.query(query)"
      ],
      "metadata": {
        "id": "nxjJ9F9RAa6n"
      },
      "id": "nxjJ9F9RAa6n",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "query = f\"\"\"\n",
        "SELECT\n",
        "  *\n",
        "FROM\n",
        "  ga4-bq-pattern.ga4_ecomm_feature_set.{prediction_data_table_name}\n",
        "LIMIT 5\n",
        "\"\"\"\n",
        "query_job = client.query(query)\n",
        "predict_data = query_job.to_dataframe()\n",
        "predict_data.head()"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 270
        },
        "id": "mz8_PxJnOPxy",
        "outputId": "d1a3dfaf-2037-4e1e-d9cd-266141bfddfd"
      },
      "id": "mz8_PxJnOPxy",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "   CENTROID_ID       user_pseudo_id  Apparel_visit_count  \\\n",
              "0            1  26181044.8175787689                    0   \n",
              "1            2  25702792.5728593498                    0   \n",
              "2            2   2978399.4786617575                    0   \n",
              "3            2  57014616.6017370091                    0   \n",
              "4            2  40003426.6235343631                    0   \n",
              "\n",
              "   ShoppingCart_visit_count  MensUnisex_visit_count  YouTube_visit_count  \\\n",
              "0                         0                      12                    0   \n",
              "1                         0                       0                    0   \n",
              "2                         0                       0                    0   \n",
              "3                         0                       0                    0   \n",
              "4                         0                       0                    0   \n",
              "\n",
              "   Sale_visit_count  TheGoogleMerchandiseStoreLogIn_visit_count  \\\n",
              "0                 0                                           0   \n",
              "1                 0                                           0   \n",
              "2                 0                                           0   \n",
              "3                 1                                           0   \n",
              "4                 1                                           0   \n",
              "\n",
              "   CheckoutYourInformation_visit_count  Storesearchresults_visit_count  \\\n",
              "0                                    0                               0   \n",
              "1                                    0                               0   \n",
              "2                                    0                               0   \n",
              "3                                    0                               1   \n",
              "4                                    0                               1   \n",
              "\n",
              "   GoogleDinoGameTee_visit_count  Drinkware_visit_count  New_visit_count  \\\n",
              "0                              0                      0                0   \n",
              "1                              0                      0                0   \n",
              "2                              0                      0                0   \n",
              "3                              0                      0                0   \n",
              "4                              0                      0                1   \n",
              "\n",
              "   Bags_visit_count  Hats_visit_count  Womens_visit_count  \\\n",
              "0                 0                 0                   0   \n",
              "1                 0                 0                   0   \n",
              "2                 0                 0                   0   \n",
              "3                 1                 0                   0   \n",
              "4                 0                 0                   0   \n",
              "\n",
              "   CampusCollection_visit_count  PageUnavailable_visit_count  \\\n",
              "0                             0                            0   \n",
              "1                             0                            0   \n",
              "2                             0                            0   \n",
              "3                             0                            0   \n",
              "4                             0                            0   \n",
              "\n",
              "   EcoFriendly_visit_count  PaymentMethod_visit_count  total_event_count  \\\n",
              "0                        0                          0                  8   \n",
              "1                        1                          0                  1   \n",
              "2                        1                          0                  1   \n",
              "3                        1                          0                  1   \n",
              "4                        1                          0                  2   \n",
              "\n",
              "   count_add_to_cart  count_purchase favorite_device_medium  \\\n",
              "0                  0               0           NotAvailable   \n",
              "1                  0               0                 mobile   \n",
              "2                  0               0                 mobile   \n",
              "3                  0               0                 mobile   \n",
              "4                  0               0                 mobile   \n",
              "\n",
              "  favorite_mobile_company_name favorite_lang most_used_country  \\\n",
              "0                 NotAvailable  NotAvailable      NotAvailable   \n",
              "1                       Google  NotAvailable             China   \n",
              "2                      <Other>  NotAvailable     United States   \n",
              "3                        Apple  NotAvailable     United States   \n",
              "4                       Xiaomi         en-us     United States   \n",
              "\n",
              "  most_used_campaign  average_engagement_time_minute  \n",
              "0       NotAvailable                             0.0  \n",
              "1       NotAvailable                             0.0  \n",
              "2       NotAvailable                             0.0  \n",
              "3       NotAvailable                             0.0  \n",
              "4         (referral)                             0.0  "
            ],
            "text/html": [
              "\n",
              "  <div id=\"df-af53f20f-1aef-4447-937d-148f8551d4ba\">\n",
              "    <div class=\"colab-df-container\">\n",
              "      <div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>CENTROID_ID</th>\n",
              "      <th>user_pseudo_id</th>\n",
              "      <th>Apparel_visit_count</th>\n",
              "      <th>ShoppingCart_visit_count</th>\n",
              "      <th>MensUnisex_visit_count</th>\n",
              "      <th>YouTube_visit_count</th>\n",
              "      <th>Sale_visit_count</th>\n",
              "      <th>TheGoogleMerchandiseStoreLogIn_visit_count</th>\n",
              "      <th>CheckoutYourInformation_visit_count</th>\n",
              "      <th>Storesearchresults_visit_count</th>\n",
              "      <th>GoogleDinoGameTee_visit_count</th>\n",
              "      <th>Drinkware_visit_count</th>\n",
              "      <th>New_visit_count</th>\n",
              "      <th>Bags_visit_count</th>\n",
              "      <th>Hats_visit_count</th>\n",
              "      <th>Womens_visit_count</th>\n",
              "      <th>CampusCollection_visit_count</th>\n",
              "      <th>PageUnavailable_visit_count</th>\n",
              "      <th>EcoFriendly_visit_count</th>\n",
              "      <th>PaymentMethod_visit_count</th>\n",
              "      <th>total_event_count</th>\n",
              "      <th>count_add_to_cart</th>\n",
              "      <th>count_purchase</th>\n",
              "      <th>favorite_device_medium</th>\n",
              "      <th>favorite_mobile_company_name</th>\n",
              "      <th>favorite_lang</th>\n",
              "      <th>most_used_country</th>\n",
              "      <th>most_used_campaign</th>\n",
              "      <th>average_engagement_time_minute</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>1</td>\n",
              "      <td>26181044.8175787689</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>12</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>8</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>0.0</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>1</th>\n",
              "      <td>2</td>\n",
              "      <td>25702792.5728593498</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>mobile</td>\n",
              "      <td>Google</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>China</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>0.0</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>2</th>\n",
              "      <td>2</td>\n",
              "      <td>2978399.4786617575</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>mobile</td>\n",
              "      <td>&lt;Other&gt;</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>United States</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>0.0</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>3</th>\n",
              "      <td>2</td>\n",
              "      <td>57014616.6017370091</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>mobile</td>\n",
              "      <td>Apple</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>United States</td>\n",
              "      <td>NotAvailable</td>\n",
              "      <td>0.0</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>4</th>\n",
              "      <td>2</td>\n",
              "      <td>40003426.6235343631</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>1</td>\n",
              "      <td>0</td>\n",
              "      <td>2</td>\n",
              "      <td>0</td>\n",
              "      <td>0</td>\n",
              "      <td>mobile</td>\n",
              "      <td>Xiaomi</td>\n",
              "      <td>en-us</td>\n",
              "      <td>United States</td>\n",
              "      <td>(referral)</td>\n",
              "      <td>0.0</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>\n",
              "      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-af53f20f-1aef-4447-937d-148f8551d4ba')\"\n",
              "              title=\"Convert this dataframe to an interactive table.\"\n",
              "              style=\"display:none;\">\n",
              "        \n",
              "  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n",
              "       width=\"24px\">\n",
              "    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n",
              "    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n",
              "  </svg>\n",
              "      </button>\n",
              "      \n",
              "  <style>\n",
              "    .colab-df-container {\n",
              "      display:flex;\n",
              "      flex-wrap:wrap;\n",
              "      gap: 12px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert {\n",
              "      background-color: #E8F0FE;\n",
              "      border: none;\n",
              "      border-radius: 50%;\n",
              "      cursor: pointer;\n",
              "      display: none;\n",
              "      fill: #1967D2;\n",
              "      height: 32px;\n",
              "      padding: 0 0 0 0;\n",
              "      width: 32px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert:hover {\n",
              "      background-color: #E2EBFA;\n",
              "      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n",
              "      fill: #174EA6;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert {\n",
              "      background-color: #3B4455;\n",
              "      fill: #D2E3FC;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert:hover {\n",
              "      background-color: #434B5C;\n",
              "      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n",
              "      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n",
              "      fill: #FFFFFF;\n",
              "    }\n",
              "  </style>\n",
              "\n",
              "      <script>\n",
              "        const buttonEl =\n",
              "          document.querySelector('#df-af53f20f-1aef-4447-937d-148f8551d4ba button.colab-df-convert');\n",
              "        buttonEl.style.display =\n",
              "          google.colab.kernel.accessAllowed ? 'block' : 'none';\n",
              "\n",
              "        async function convertToInteractive(key) {\n",
              "          const element = document.querySelector('#df-af53f20f-1aef-4447-937d-148f8551d4ba');\n",
              "          const dataTable =\n",
              "            await google.colab.kernel.invokeFunction('convertToInteractive',\n",
              "                                                     [key], {});\n",
              "          if (!dataTable) return;\n",
              "\n",
              "          const docLinkHtml = 'Like what you see? Visit the ' +\n",
              "            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n",
              "            + ' to learn more about interactive tables.';\n",
              "          element.innerHTML = '';\n",
              "          dataTable['output_type'] = 'display_data';\n",
              "          await google.colab.output.renderOutput(dataTable, element);\n",
              "          const docLink = document.createElement('div');\n",
              "          docLink.innerHTML = docLinkHtml;\n",
              "          element.appendChild(docLink);\n",
              "        }\n",
              "      </script>\n",
              "    </div>\n",
              "  </div>\n",
              "  "
            ]
          },
          "metadata": {},
          "execution_count": 35
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "You can see the table with predictions has a column `CENTROID_ID` that contains their cluster assignment."
      ],
      "metadata": {
        "id": "0XrobniqOVGB"
      },
      "id": "0XrobniqOVGB"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Prediction Analysis"
      ],
      "metadata": {
        "id": "bgUVx0uxASZd"
      },
      "id": "bgUVx0uxASZd"
    },
    {
      "cell_type": "markdown",
      "source": [
        "The last step would be to analyze and understand each cluster in more detail. This analysis will help customize triggers to Google Ads Connector later.\n",
        "\n",
        "This step is also crucial since it helps validate the segmentation modeling from a business point of view and helps pivot if necessary.\n",
        "\n",
        "To achieve the cluster-specific behavior, you can do a `group by` `CENTROID_ID` and get the weights' average.\n",
        "\n",
        "The average weight signifies their affinity to \"visit\" or \"browse\" specific pages they have visited. This value can help identify clusters of people interested in some particular types of pages, as one of the clusters could be everyone who likes \"Hats,\" etc.\n",
        "\n",
        "\n",
        "For simplification, we are only trying to segment customers based on their affinity to visit some specific pages like \"hats,\" \"apparel,\" \"drinkware,\" etc.\n",
        "\n",
        "You can and should include more features based on your business requirements."
      ],
      "metadata": {
        "id": "D2IkHZiroFEj"
      },
      "id": "D2IkHZiroFEj"
    },
    {
      "cell_type": "code",
      "source": [
        "query = f\"\"\"\n",
        "SELECT\n",
        "  CENTROID_ID,\n",
        "  COUNT(user_pseudo_id) as total_user,\n",
        "  AVG(Apparel_visit_count) as avg_apparel_weight,\n",
        "  AVG(MensUnisex_visit_count) as avg_unisex_weight,\n",
        "  AVG(Drinkware_visit_count) as avg_drinkware_weight,\n",
        "  AVG(Bags_visit_count) as avg_bags_weight,\n",
        "  AVG(Hats_visit_count) as avg_hats_weight,\n",
        "  AVG(Womens_visit_count) as avg_womens_weight,\n",
        "  AVG(CampusCollection_visit_count) as avg_campus_weight,\n",
        "  AVG(Sale_visit_count) as avg_salepage_weight,\n",
        "  AVG(YouTube_visit_count) as avg_youtubepage_weight,\n",
        "  AVG(average_engagement_time_minute) as avg_timespent\n",
        "FROM\n",
        "  `{PROJECT_ID}.{dataset_id}.{prediction_data_table_name}`\n",
        "GROUP BY CENTROID_ID\n",
        "ORDER BY CENTROID_ID\n",
        "\"\"\"\n",
        "query_job = client.query(query)\n",
        "predict_data = query_job.to_dataframe()\n",
        "predict_data.head()"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 270
        },
        "id": "K8suehp0c3Xf",
        "outputId": "7d793a62-eaac-40b9-ff9a-dd4f8f237621"
      },
      "id": "K8suehp0c3Xf",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "   CENTROID_ID  total_user  avg_apparel_weight  avg_unisex_weight  \\\n",
              "0            1        1598            0.717146           0.753442   \n",
              "1            2           1            5.000000           1.000000   \n",
              "2            3        3731            0.927365           2.177968   \n",
              "3            4        3575            0.898741           3.473287   \n",
              "4            5      150085            0.492208           0.164174   \n",
              "\n",
              "   avg_drinkware_weight  avg_bags_weight  avg_hats_weight  avg_womens_weight  \\\n",
              "0              0.655194         2.909262         0.182728           0.230914   \n",
              "1              0.000000         0.000000         8.000000           0.000000   \n",
              "2              1.124363         0.951220         1.943179           1.235862   \n",
              "3              1.313846         0.830769         0.620979           1.535105   \n",
              "4              0.104461         0.075344         0.063158           0.048439   \n",
              "\n",
              "   avg_campus_weight  avg_salepage_weight  avg_youtubepage_weight  \\\n",
              "0           0.273467             0.512516                0.193992   \n",
              "1           0.000000             0.000000                0.000000   \n",
              "2           1.213884             1.602787                0.487001   \n",
              "3           0.966993             2.786294                0.212587   \n",
              "4           0.083146             0.143745                0.249685   \n",
              "\n",
              "   avg_timespent  \n",
              "0       0.128217  \n",
              "1       0.470000  \n",
              "2       0.206601  \n",
              "3       0.203678  \n",
              "4       0.056996  "
            ],
            "text/html": [
              "\n",
              "  <div id=\"df-67ed527d-3316-42c2-9903-7be12bac7daf\">\n",
              "    <div class=\"colab-df-container\">\n",
              "      <div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>CENTROID_ID</th>\n",
              "      <th>total_user</th>\n",
              "      <th>avg_apparel_weight</th>\n",
              "      <th>avg_unisex_weight</th>\n",
              "      <th>avg_drinkware_weight</th>\n",
              "      <th>avg_bags_weight</th>\n",
              "      <th>avg_hats_weight</th>\n",
              "      <th>avg_womens_weight</th>\n",
              "      <th>avg_campus_weight</th>\n",
              "      <th>avg_salepage_weight</th>\n",
              "      <th>avg_youtubepage_weight</th>\n",
              "      <th>avg_timespent</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>1</td>\n",
              "      <td>1598</td>\n",
              "      <td>0.717146</td>\n",
              "      <td>0.753442</td>\n",
              "      <td>0.655194</td>\n",
              "      <td>2.909262</td>\n",
              "      <td>0.182728</td>\n",
              "      <td>0.230914</td>\n",
              "      <td>0.273467</td>\n",
              "      <td>0.512516</td>\n",
              "      <td>0.193992</td>\n",
              "      <td>0.128217</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>1</th>\n",
              "      <td>2</td>\n",
              "      <td>1</td>\n",
              "      <td>5.000000</td>\n",
              "      <td>1.000000</td>\n",
              "      <td>0.000000</td>\n",
              "      <td>0.000000</td>\n",
              "      <td>8.000000</td>\n",
              "      <td>0.000000</td>\n",
              "      <td>0.000000</td>\n",
              "      <td>0.000000</td>\n",
              "      <td>0.000000</td>\n",
              "      <td>0.470000</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>2</th>\n",
              "      <td>3</td>\n",
              "      <td>3731</td>\n",
              "      <td>0.927365</td>\n",
              "      <td>2.177968</td>\n",
              "      <td>1.124363</td>\n",
              "      <td>0.951220</td>\n",
              "      <td>1.943179</td>\n",
              "      <td>1.235862</td>\n",
              "      <td>1.213884</td>\n",
              "      <td>1.602787</td>\n",
              "      <td>0.487001</td>\n",
              "      <td>0.206601</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>3</th>\n",
              "      <td>4</td>\n",
              "      <td>3575</td>\n",
              "      <td>0.898741</td>\n",
              "      <td>3.473287</td>\n",
              "      <td>1.313846</td>\n",
              "      <td>0.830769</td>\n",
              "      <td>0.620979</td>\n",
              "      <td>1.535105</td>\n",
              "      <td>0.966993</td>\n",
              "      <td>2.786294</td>\n",
              "      <td>0.212587</td>\n",
              "      <td>0.203678</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>4</th>\n",
              "      <td>5</td>\n",
              "      <td>150085</td>\n",
              "      <td>0.492208</td>\n",
              "      <td>0.164174</td>\n",
              "      <td>0.104461</td>\n",
              "      <td>0.075344</td>\n",
              "      <td>0.063158</td>\n",
              "      <td>0.048439</td>\n",
              "      <td>0.083146</td>\n",
              "      <td>0.143745</td>\n",
              "      <td>0.249685</td>\n",
              "      <td>0.056996</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>\n",
              "      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-67ed527d-3316-42c2-9903-7be12bac7daf')\"\n",
              "              title=\"Convert this dataframe to an interactive table.\"\n",
              "              style=\"display:none;\">\n",
              "        \n",
              "  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n",
              "       width=\"24px\">\n",
              "    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n",
              "    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n",
              "  </svg>\n",
              "      </button>\n",
              "      \n",
              "  <style>\n",
              "    .colab-df-container {\n",
              "      display:flex;\n",
              "      flex-wrap:wrap;\n",
              "      gap: 12px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert {\n",
              "      background-color: #E8F0FE;\n",
              "      border: none;\n",
              "      border-radius: 50%;\n",
              "      cursor: pointer;\n",
              "      display: none;\n",
              "      fill: #1967D2;\n",
              "      height: 32px;\n",
              "      padding: 0 0 0 0;\n",
              "      width: 32px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert:hover {\n",
              "      background-color: #E2EBFA;\n",
              "      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n",
              "      fill: #174EA6;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert {\n",
              "      background-color: #3B4455;\n",
              "      fill: #D2E3FC;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert:hover {\n",
              "      background-color: #434B5C;\n",
              "      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n",
              "      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n",
              "      fill: #FFFFFF;\n",
              "    }\n",
              "  </style>\n",
              "\n",
              "      <script>\n",
              "        const buttonEl =\n",
              "          document.querySelector('#df-67ed527d-3316-42c2-9903-7be12bac7daf button.colab-df-convert');\n",
              "        buttonEl.style.display =\n",
              "          google.colab.kernel.accessAllowed ? 'block' : 'none';\n",
              "\n",
              "        async function convertToInteractive(key) {\n",
              "          const element = document.querySelector('#df-67ed527d-3316-42c2-9903-7be12bac7daf');\n",
              "          const dataTable =\n",
              "            await google.colab.kernel.invokeFunction('convertToInteractive',\n",
              "                                                     [key], {});\n",
              "          if (!dataTable) return;\n",
              "\n",
              "          const docLinkHtml = 'Like what you see? Visit the ' +\n",
              "            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n",
              "            + ' to learn more about interactive tables.';\n",
              "          element.innerHTML = '';\n",
              "          dataTable['output_type'] = 'display_data';\n",
              "          await google.colab.output.renderOutput(dataTable, element);\n",
              "          const docLink = document.createElement('div');\n",
              "          docLink.innerHTML = docLinkHtml;\n",
              "          element.appendChild(docLink);\n",
              "        }\n",
              "      </script>\n",
              "    </div>\n",
              "  </div>\n",
              "  "
            ]
          },
          "metadata": {},
          "execution_count": 64
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "Once you have the average values for each feature (numerical), you can find the most dominant feature where the values are high.\n",
        "\n",
        "For that, you can take the top 2 values and their feature names for each cluster. You can also write a dynamic python function that takes all the rows and then sorts them to take the topmost values based on N (2 in our case, since we need the top 2 high values).\n",
        "\n",
        "The N is dominanat_category in the code.\n"
      ],
      "metadata": {
        "id": "FbfGcPMSoN80"
      },
      "id": "FbfGcPMSoN80"
    },
    {
      "cell_type": "code",
      "source": [
        "dominant_category=2\n",
        "def check_max(row):\n",
        "  new_row = row.drop(['total_user','CENTROID_ID','avg_timespent'])\n",
        "  return(list(new_row.sort_values(ascending=False).index)[:dominant_category])\n",
        "\n",
        "predict_data['dominant_categories'] = predict_data.apply(check_max,axis=1)"
      ],
      "metadata": {
        "id": "1t3TEqriTMls"
      },
      "id": "1t3TEqriTMls",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "predict_data[['CENTROID_ID','total_user','dominant_categories']]"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 206
        },
        "id": "ApWUb_4lVqcr",
        "outputId": "63dc5035-ef69-49f1-b32a-8800af5eca00"
      },
      "id": "ApWUb_4lVqcr",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "   CENTROID_ID  total_user                           dominant_categories\n",
              "0            1        1598          [avg_bags_weight, avg_unisex_weight]\n",
              "1            2           1         [avg_hats_weight, avg_apparel_weight]\n",
              "2            3        3731          [avg_unisex_weight, avg_hats_weight]\n",
              "3            4        3575      [avg_unisex_weight, avg_salepage_weight]\n",
              "4            5      150085  [avg_apparel_weight, avg_youtubepage_weight]"
            ],
            "text/html": [
              "\n",
              "  <div id=\"df-a258a6fd-057d-4a7e-8065-4c0ec02a331c\">\n",
              "    <div class=\"colab-df-container\">\n",
              "      <div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>CENTROID_ID</th>\n",
              "      <th>total_user</th>\n",
              "      <th>dominant_categories</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>1</td>\n",
              "      <td>1598</td>\n",
              "      <td>[avg_bags_weight, avg_unisex_weight]</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>1</th>\n",
              "      <td>2</td>\n",
              "      <td>1</td>\n",
              "      <td>[avg_hats_weight, avg_apparel_weight]</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>2</th>\n",
              "      <td>3</td>\n",
              "      <td>3731</td>\n",
              "      <td>[avg_unisex_weight, avg_hats_weight]</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>3</th>\n",
              "      <td>4</td>\n",
              "      <td>3575</td>\n",
              "      <td>[avg_unisex_weight, avg_salepage_weight]</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>4</th>\n",
              "      <td>5</td>\n",
              "      <td>150085</td>\n",
              "      <td>[avg_apparel_weight, avg_youtubepage_weight]</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>\n",
              "      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-a258a6fd-057d-4a7e-8065-4c0ec02a331c')\"\n",
              "              title=\"Convert this dataframe to an interactive table.\"\n",
              "              style=\"display:none;\">\n",
              "        \n",
              "  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n",
              "       width=\"24px\">\n",
              "    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n",
              "    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n",
              "  </svg>\n",
              "      </button>\n",
              "      \n",
              "  <style>\n",
              "    .colab-df-container {\n",
              "      display:flex;\n",
              "      flex-wrap:wrap;\n",
              "      gap: 12px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert {\n",
              "      background-color: #E8F0FE;\n",
              "      border: none;\n",
              "      border-radius: 50%;\n",
              "      cursor: pointer;\n",
              "      display: none;\n",
              "      fill: #1967D2;\n",
              "      height: 32px;\n",
              "      padding: 0 0 0 0;\n",
              "      width: 32px;\n",
              "    }\n",
              "\n",
              "    .colab-df-convert:hover {\n",
              "      background-color: #E2EBFA;\n",
              "      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n",
              "      fill: #174EA6;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert {\n",
              "      background-color: #3B4455;\n",
              "      fill: #D2E3FC;\n",
              "    }\n",
              "\n",
              "    [theme=dark] .colab-df-convert:hover {\n",
              "      background-color: #434B5C;\n",
              "      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n",
              "      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n",
              "      fill: #FFFFFF;\n",
              "    }\n",
              "  </style>\n",
              "\n",
              "      <script>\n",
              "        const buttonEl =\n",
              "          document.querySelector('#df-a258a6fd-057d-4a7e-8065-4c0ec02a331c button.colab-df-convert');\n",
              "        buttonEl.style.display =\n",
              "          google.colab.kernel.accessAllowed ? 'block' : 'none';\n",
              "\n",
              "        async function convertToInteractive(key) {\n",
              "          const element = document.querySelector('#df-a258a6fd-057d-4a7e-8065-4c0ec02a331c');\n",
              "          const dataTable =\n",
              "            await google.colab.kernel.invokeFunction('convertToInteractive',\n",
              "                                                     [key], {});\n",
              "          if (!dataTable) return;\n",
              "\n",
              "          const docLinkHtml = 'Like what you see? Visit the ' +\n",
              "            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n",
              "            + ' to learn more about interactive tables.';\n",
              "          element.innerHTML = '';\n",
              "          dataTable['output_type'] = 'display_data';\n",
              "          await google.colab.output.renderOutput(dataTable, element);\n",
              "          const docLink = document.createElement('div');\n",
              "          docLink.innerHTML = docLinkHtml;\n",
              "          element.appendChild(docLink);\n",
              "        }\n",
              "      </script>\n",
              "    </div>\n",
              "  </div>\n",
              "  "
            ]
          },
          "metadata": {},
          "execution_count": 66
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "This will give each cluster the most dominant features (based on their highest average weight of page viewing) and total_user in each cluster. Now that you have that, you can explain the characteristics property of each cluster.\n",
        "\n",
        "- Cluster 1 -> Customers who love bags and are interested in unisex collections.\n",
        "- Cluster 2 -> Customers who love hats and apparel.\n",
        "- Cluster 3 -> Customers who love hats but also love unisex collections. This is similar to cluster 2 since both customers love hats. You can combine both clusters (2 & 3) and call customers who love hats.\n",
        "- Cluster 4 -> Customers who are only interested in unisex collections, and usually visit the sales page. They can be targeted if a sale goes in a unisex collection.\n",
        "- Cluster 5 -> Customers who are interested in the general apparel section and love the YouTube merchandise. They can be targeted for any new apparel launches or some new merchandise for YouTube.\n",
        "\n",
        "\n",
        "These overly simplified characteristics assume other features do not affect their browsing behavior. Sometimes, simplification is essential to make the single characteristics stand out and make targeting easier.\n",
        "\n",
        "This is not 100% correct segments, but they are approximately correct. The goal is not to find 100% accurate clusters but to find some approximation of their behaviors such that some Google Ads targeting can be done in dynamic ways.\n"
      ],
      "metadata": {
        "id": "d4DUw49sosUz"
      },
      "id": "d4DUw49sosUz"
    },
    {
      "cell_type": "markdown",
      "source": [
        "\n",
        "\n",
        "---\n",
        "\n",
        "\n",
        "You can also plot the weights in Heat Maps. Heats maps are easier to identify the dominant features because of the value legend on the right.\n",
        "\n",
        "For example, Cluster 2 can be seen as dominant with \"hats\" and \"apparel.\""
      ],
      "metadata": {
        "id": "ArrMQ5Pfn9ue"
      },
      "id": "ArrMQ5Pfn9ue"
    },
    {
      "cell_type": "code",
      "source": [
        "fig = px.imshow(predict_data.drop('total_user',axis=1), text_auto=True)\n",
        "fig.show()"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 542
        },
        "id": "6RNk4aEoc7UN",
        "outputId": "29c234cd-8b8e-4c6e-a3d6-19a3eb6cfa73"
      },
      "id": "6RNk4aEoc7UN",
      "execution_count": null,
      "outputs": [
        {
          "output_type": "display_data",
          "data": {
            "text/html": [
              "<html>\n",
              "<head><meta charset=\"utf-8\" /></head>\n",
              "<body>\n",
              "    <div>            <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG\"></script><script type=\"text/javascript\">if (window.MathJax) {MathJax.Hub.Config({SVG: {font: \"STIX-Web\"}});}</script>                <script type=\"text/javascript\">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>\n",
              "        <script src=\"https://cdn.plot.ly/plotly-2.8.3.min.js\"></script>                <div id=\"00a808ad-6546-4fc4-a4cd-4b63d5f347e1\" class=\"plotly-graph-div\" style=\"height:525px; width:100%;\"></div>            <script type=\"text/javascript\">                                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById(\"00a808ad-6546-4fc4-a4cd-4b63d5f347e1\")) {                    Plotly.newPlot(                        \"00a808ad-6546-4fc4-a4cd-4b63d5f347e1\",                        [{\"coloraxis\":\"coloraxis\",\"name\":\"0\",\"texttemplate\":\"%{z}\",\"x\":[\"CENTROID_ID\",\"avg_apparel_weight\",\"avg_unisex_weight\",\"avg_drinkware_weight\",\"avg_bags_weight\",\"avg_hats_weight\",\"avg_womens_weight\",\"avg_campus_weight\",\"avg_salepage_weight\",\"avg_youtubepage_weight\",\"avg_timespent\"],\"y\":[0,1,2,3,4],\"z\":[[1.0,0.7171464330413018,0.7534418022528153,0.6551939924906129,2.909261576971219,0.18272841051314165,0.23091364205256537,0.2734668335419273,0.5125156445556945,0.19399249061326637,0.12821652065081326],[2.0,5.0,1.0,0.0,0.0,8.0,0.0,0.0,0.0,0.0,0.47],[3.0,0.9273653176092188,2.1779683730903288,1.1243634414366104,0.9512195121951218,1.9431787724470657,1.2358616992763334,1.2138836772983126,1.6027874564459959,0.48700080407397445,0.20660144733315458],[4.0,0.8987412587412585,3.473286713286711,1.313846153846151,0.8307692307692316,0.6209790209790192,1.5351048951048938,0.9669930069930074,2.7862937062937077,0.21258741258741257,0.2036783216783217],[5.0,0.49220774894226627,0.16417363494019768,0.10446080554352671,0.07534397174934303,0.0631575440583676,0.048439217776593615,0.08314621714361875,0.14374521104707189,0.2496851783989106,0.05699590232201821]],\"type\":\"heatmap\",\"xaxis\":\"x\",\"yaxis\":\"y\",\"hovertemplate\":\"x: %{x}<br>y: %{y}<br>color: %{z}<extra></extra>\"}],                        {\"template\":{\"data\":{\"bar\":[{\"error_x\":{\"color\":\"#2a3f5f\"},\"error_y\":{\"color\":\"#2a3f5f\"},\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"bar\"}],\"barpolar\":[{\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"barpolar\"}],\"carpet\":[{\"aaxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"baxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"type\":\"carpet\"}],\"choropleth\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"choropleth\"}],\"contour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"contour\"}],\"contourcarpet\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"contourcarpet\"}],\"heatmap\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmap\"}],\"heatmapgl\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmapgl\"}],\"histogram\":[{\"marker\":{\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"histogram\"}],\"histogram2d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2d\"}],\"histogram2dcontour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2dcontour\"}],\"mesh3d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"mesh3d\"}],\"parcoords\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"parcoords\"}],\"pie\":[{\"automargin\":true,\"type\":\"pie\"}],\"scatter\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter\"}],\"scatter3d\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter3d\"}],\"scattercarpet\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattercarpet\"}],\"scattergeo\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergeo\"}],\"scattergl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergl\"}],\"scattermapbox\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattermapbox\"}],\"scatterpolar\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolar\"}],\"scatterpolargl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolargl\"}],\"scatterternary\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterternary\"}],\"surface\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"surface\"}],\"table\":[{\"cells\":{\"fill\":{\"color\":\"#EBF0F8\"},\"line\":{\"color\":\"white\"}},\"header\":{\"fill\":{\"color\":\"#C8D4E3\"},\"line\":{\"color\":\"white\"}},\"type\":\"table\"}]},\"layout\":{\"annotationdefaults\":{\"arrowcolor\":\"#2a3f5f\",\"arrowhead\":0,\"arrowwidth\":1},\"autotypenumbers\":\"strict\",\"coloraxis\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"colorscale\":{\"diverging\":[[0,\"#8e0152\"],[0.1,\"#c51b7d\"],[0.2,\"#de77ae\"],[0.3,\"#f1b6da\"],[0.4,\"#fde0ef\"],[0.5,\"#f7f7f7\"],[0.6,\"#e6f5d0\"],[0.7,\"#b8e186\"],[0.8,\"#7fbc41\"],[0.9,\"#4d9221\"],[1,\"#276419\"]],\"sequential\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"sequentialminus\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]},\"colorway\":[\"#636efa\",\"#EF553B\",\"#00cc96\",\"#ab63fa\",\"#FFA15A\",\"#19d3f3\",\"#FF6692\",\"#B6E880\",\"#FF97FF\",\"#FECB52\"],\"font\":{\"color\":\"#2a3f5f\"},\"geo\":{\"bgcolor\":\"white\",\"lakecolor\":\"white\",\"landcolor\":\"#E5ECF6\",\"showlakes\":true,\"showland\":true,\"subunitcolor\":\"white\"},\"hoverlabel\":{\"align\":\"left\"},\"hovermode\":\"closest\",\"mapbox\":{\"style\":\"light\"},\"paper_bgcolor\":\"white\",\"plot_bgcolor\":\"#E5ECF6\",\"polar\":{\"angularaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"radialaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"scene\":{\"xaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"yaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"},\"zaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"gridwidth\":2,\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\"}},\"shapedefaults\":{\"line\":{\"color\":\"#2a3f5f\"}},\"ternary\":{\"aaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"baxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"bgcolor\":\"#E5ECF6\",\"caxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"title\":{\"x\":0.05},\"xaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2},\"yaxis\":{\"automargin\":true,\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"zerolinewidth\":2}}},\"xaxis\":{\"anchor\":\"y\",\"domain\":[0.0,1.0],\"scaleanchor\":\"y\",\"constrain\":\"domain\"},\"yaxis\":{\"anchor\":\"x\",\"domain\":[0.0,1.0],\"autorange\":\"reversed\",\"constrain\":\"domain\"},\"coloraxis\":{\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]},\"margin\":{\"t\":60}},                        {\"responsive\": true}                    ).then(function(){\n",
              "                            \n",
              "var gd = document.getElementById('00a808ad-6546-4fc4-a4cd-4b63d5f347e1');\n",
              "var x = new MutationObserver(function (mutations, observer) {{\n",
              "        var display = window.getComputedStyle(gd).display;\n",
              "        if (!display || display === 'none') {{\n",
              "            console.log([gd, 'removed!']);\n",
              "            Plotly.purge(gd);\n",
              "            observer.disconnect();\n",
              "        }}\n",
              "}});\n",
              "\n",
              "// Listen for the removal of the full notebook cells\n",
              "var notebookContainer = gd.closest('#notebook-container');\n",
              "if (notebookContainer) {{\n",
              "    x.observe(notebookContainer, {childList: true});\n",
              "}}\n",
              "\n",
              "// Listen for the clearing of the current output cell\n",
              "var outputEl = gd.closest('.output');\n",
              "if (outputEl) {{\n",
              "    x.observe(outputEl, {childList: true});\n",
              "}}\n",
              "\n",
              "                        })                };                            </script>        </div>\n",
              "</body>\n",
              "</html>"
            ]
          },
          "metadata": {}
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "\n",
        "\n",
        "\n",
        "\n",
        "## Next Steps"
      ],
      "metadata": {
        "id": "MneZoCsCAjeT"
      },
      "id": "MneZoCsCAjeT"
    },
    {
      "cell_type": "markdown",
      "source": [
        "Once everything is finalized and your business has given the green light on cluster characteristics, it's time to integrate this further into Google Ads Connector.\n",
        "\n",
        "The GAC (commonly referred to as Tentacles) can send a massive amount of data to GMP (e.g., Google Analytics, Campaign Manager) or Google Ads automatically and reliably.\n",
        "\n",
        "In the next part of the series in the GA4 patterns, you will see how to achieve the integration.\n",
        "\n",
        "First, you will learn to set up Tentacles and then connect it to BQ table where we have the final centroids for all `user_pseudo_ids`."
      ],
      "metadata": {
        "id": "GrlLtarQn2a4"
      },
      "id": "GrlLtarQn2a4"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## Clean Up"
      ],
      "metadata": {
        "id": "bdeJo1Q7d-xY"
      },
      "id": "bdeJo1Q7d-xY"
    },
    {
      "cell_type": "code",
      "source": [
        "# # Are you sure you want to do this? This is to delete all models\n",
        "# models = client.list_models(dataset_id) # Make an API request.\n",
        "# for model in models:\n",
        "#     full_model_id = f\"{model.dataset_id}.{model.model_id}\"\n",
        "#     client.delete_model(full_model_id)  # Make an API request.\n",
        "#     print(f\"Deleted: {full_model_id}\")\n",
        "# # Are you sure you want to do this? This is to delete all tables and views\n",
        "# tables = client.list_tables(dataset_id)  # Make an API request.\n",
        "# for table in tables:\n",
        "#     full_table_id = f\"{table.dataset_id}.{table.table_id}\"\n",
        "#     client.delete_table(full_table_id)  # Make an API request.\n",
        "#     print(f\"Deleted: {full_table_id}\")"
      ],
      "metadata": {
        "id": "vFSfNFYMeFIN"
      },
      "id": "vFSfNFYMeFIN",
      "execution_count": null,
      "outputs": []
    }
  ],
  "metadata": {
    "environment": {
      "kernel": "python3",
      "name": "common-cpu.m87",
      "type": "gcloud",
      "uri": "gcr.io/deeplearning-platform-release/base-cpu:m87"
    },
    "kernelspec": {
      "display_name": "Python 3",
      "language": "python",
      "name": "python3"
    },
    "language_info": {
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "file_extension": ".py",
      "mimetype": "text/x-python",
      "name": "python",
      "nbconvert_exporter": "python",
      "pygments_lexer": "ipython3",
      "version": "3.7.12"
    },
    "colab": {
      "provenance": [],
      "collapsed_sections": [
        "cmiF7wD2IXbk",
        "MneZoCsCAjeT"
      ]
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}